<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub SLAP</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Palette: SLAP Brand Colors: #F1D24B (Yellow), #FF5C3D (Orange), #84C7DF (Blue), #8671D1 (Purple) -->
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            line-height: 1.25;
        }
        .nav-item.active {
            background-color: #FFFBEB; /* yellow-50 */
            color: #F1D24B;
            font-weight: 600;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e7e5e4; padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h4 { font-size: 1.25rem; font-weight: 700; color: #44403c; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: #a8a29e; }
        
        .base-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s; }
        .base-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .status-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-aprovado, .status-presencial, .status-ativo { background-color: #D1FAE5; color: #065F46; }
        .status-online, .status-em-andamento, .status-inativo { background-color: #DBEAFE; color: #1E40AF; }
        .status-concluída { background-color: #F3F4F6; color: #4B5563; }
        .status-pendente, .status-em-espera { background-color: #FEF3C7; color: #92400E; }
        .status-rejeitado, .status-cancelado { background-color: #FEE2E2; color: #991B1B; }

        .status-financeiro { background-color: #D1FAE5; color: #065F46; }
        .status-pedagógico { background-color: #DBEAFE; color: #1E40AF; }
        .status-comercial { background-color: #FEF3C7; color: #92400E; }
        .status-marketing { background-color: #FEE2E2; color: #991B1B; }
        
        .sector-tag, .keyword-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1.5px solid #F1D24B;
            color: #44403c;
            background-color: transparent;
        }

        .task-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s ease; }
        .task-card.completed { background-color: #f9fafb; border-color: #e5e7eb; }
        .task-card.completed p { text-decoration: line-through; color: #9ca3af; }
        .task-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .user-tag { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .tag-admin { background-color: #E5E7EB; color: #374151; }
        .deadline-text { font-weight: 600; color: #57534e; }
        .deadline-overdue { color: #b91c1c; }
        .task-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        .task-delete-btn:hover { color: #ef4444; }

        .grade-select-container { margin-bottom: 1.5rem; max-width: 400px; }
        .grade-select { width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #d6d3d1; background-color: #ffffff; font-weight: 600; color: #44403c; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; cursor: pointer; }
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .day-column { background-color: #f9fafb; border-radius: 0.75rem; padding: 1rem; border: 1px solid #f3f4f6; }
        .day-column-header { font-weight: 700; color: #44403c; font-size: 1.25rem; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 2px solid #F1D24B; }
        .class-entry { background-color: #ffffff; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .class-entry:hover { transform: translateY(-2px); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .class-tag { font-size: 0.625rem; font-weight: 700; padding: 2px 8px; border-radius: 9999px; color: white; margin-bottom: 4px; display: inline-block; text-transform: uppercase; }
        .tag-turma { background-color: #FF5C3D; }
        .tag-vip { background-color: #8671D1; }
        
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { font-weight: 600; font-size: 0.875rem; color: #6b7280; }
        .data-table tbody tr.paid { background-color: #f9fafb; color: #9ca3af; }
        .data-table tbody tr.paid .font-medium { text-decoration: line-through; }
        .data-table tbody tr:not(.paid):hover { background-color: #f9fafb; cursor: pointer; }
        .data-total { margin-top: 1.5rem; text-align: right; }
        .data-total p { font-size: 1.25rem; font-weight: 700; color: #1f2937; }

        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .form-input:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        .primary-btn { background-color: #F1D24B; color: #44403c; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; width: 100%; border: none; cursor: pointer; }
        .primary-btn:hover { background-color: #eab308; }
        .secondary-btn { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .secondary-btn:hover { background-color: #e5e7eb; }
        .secondary-btn.active { background-color: #F1D24B; color: #44403c; border-color: #F1D24B;}
        .danger-btn { background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; border: none; cursor: pointer; }
        .danger-btn:hover { background-color: #dc2626; }

        /* --- CPs Styles --- */
        .cp-level-card { background-color: #fff; border-radius: 0.75rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; }
        .cp-level-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cp-level-content { padding: 0 1.5rem; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding-bottom 0.3s ease-out; }
        .cp-level-card.open .cp-level-content { max-height: 6000px; padding-bottom: 1.5rem; }
        .cp-lesson-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; }
        .cp-lesson-item:nth-child(odd) { background-color: #f9fafb; }

        /* --- Banco de Fotos Styles --- */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; }
        .folder-card { background-color: #fff; border-radius: 0.75rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid #e7e5e4; position: relative; }
        .folder-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #F1D24B; }
        .folder-delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; cursor: pointer; color: #d1d5db; padding: 0.25rem; border-radius: 9999px; }
        .folder-card:hover .folder-delete-btn { color: #9ca3af; }
        .folder-delete-btn:hover { color: #ef4444; background-color: #fef2f2; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .photo-card { background-color: #fff; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; }
        .photo-card img { width: 100%; height: 200px; object-fit: cover; }
        .photo-card-info { padding: 1rem; }

        /* --- PEF Styles (Integrated) --- */
        .pef-lesson-row { display: grid; grid-template-columns: 80px 150px 1fr; align-items: start; gap: 1rem; padding: 1rem 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .pef-lesson-row:last-child { border-bottom: none; }
        .pef-student-attendance-row { display: flex; align-items: center; justify-content: space-between; margin-left: 1rem; padding: 0.5rem 0; }
        .pef-status-btn-group button { width: 2.5rem; height: 2.5rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background-color: #f9fafb; }
        .pef-status-btn-group button:hover { border-color: #a8a29e; }
        .pef-status-btn-group button.active.P { background-color: #10B981; color: white; border-color: #10B981; }
        .pef-status-btn-group button.active.F { background-color: #EF4444; color: white; border-color: #EF4444; }
        .pef-status-btn-group button.active.PP { background-color: #F59E0B; color: white; border-color: #F59E0B; }

        /* --- Calendar Styles --- */
        .calendar-container { max-width: 1200px; margin: 0 auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .calendar-nav-btn { background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .calendar-nav-btn:hover { background-color: #e5e7eb; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .calendar-day-header { background-color: #f9fafb; padding: 1rem; text-align: center; font-weight: 700; color: #44403c; }
        .calendar-day { background-color: white; min-height: 120px; padding: 0.5rem; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .calendar-day:hover { background-color: #fffbeb; }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-day.today { background-color: #fef3c7; border: 2px solid #F1D24B; }
        .calendar-day-number { font-weight: 600; margin-bottom: 0.25rem; }
        .calendar-event { background-color: #F1D24B; color: #44403c; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.75rem; margin-bottom: 0.125rem; cursor: pointer; display: block; }
        .calendar-event:hover { background-color: #eab308; }
        .calendar-event.gravacao { background-color: #10B981; color: white; }
        .calendar-event.lembrete { background-color: #F59E0B; color: white; }
        .calendar-event.evento { background-color: #8671D1; color: white; }
        .calendar-event.aula-extra { background-color: #FF5C3D; color: white; }
        .calendar-event.data-comemorativa { background-color: #84C7DF; color: white; }
        .calendar-event.reuniao { background-color: #6B7280; color: white; }

        /* --- Monthly Highlight Styles --- */
        .highlight-card { display: flex; gap: 1rem; align-items: center; }
        .highlight-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #F1D24B; }
        .highlight-info h5 { font-size: 1.125rem; font-weight: 700; color: #44403c; margin-bottom: 0.25rem; }
        .highlight-info p { color: #6b7280; font-size: 0.875rem; line-height: 1.4; }
        .highlight-award { color: #059669; font-size: 0.875rem; margin-top: 0.5rem; }
        .highlight-empty { text-align: center; padding: 2rem; color: #9ca3af; }

        /* --- Pedagogical Challenge Styles --- */
        .quiz-option {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            text-align: left;
            background-color: #f5f5f4;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .quiz-option:hover:not(:disabled) {
            background-color: #e7e5e4;
            border-color: #F1D24B;
        }
        .quiz-option:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        .quiz-option.correct {
            background-color: #D1FAE5;
            border-color: #34D399;
            color: #065F46;
            font-weight: 600;
        }
        .quiz-option.incorrect {
            background-color: #FEE2E2;
            border-color: #F87171;
            color: #991B1B;
            font-weight: 600;
        }
        .audio-player-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 450px;
            background-color: #f5f5f4;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
        }
        .play-pause-button {
            background-color: #F1D24B;
            color: #44403c;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .play-pause-button:hover { background-color: #eab308; }
        .play-pause-button svg { width: 20px; height: 20px; }
        .progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #e7e5e4; border-radius: 3px; outline: none; cursor: pointer; }
        .progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #44403c; border-radius: 50%; cursor: pointer; }
        .progress-bar::-moz-range-thumb { width: 16px; height: 16px; background: #44403c; border-radius: 50%; cursor: pointer; }
        .time-display { font-size: 0.875rem; color: #57534e; min-width: 80px; text-align: center; }
        #certificate {
            background: linear-gradient(45deg, #fffbeb, #f0f9ff);
        }

        /* --- Guidelines Styles --- */
        .guidelines-search { width: 100%; max-width: 400px; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 2rem; }
        .guideline-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.2s; }
        .guideline-card.good-practice { border-left: 4px solid #10B981; }
        .guideline-card.prohibited { border-left: 4px solid #EF4444; }
        .guideline-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .guideline-icon { margin-right: 0.75rem; }
        .guideline-header { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .guideline-title { font-size: 1.125rem; font-weight: 700; color: #44403c; }
        .guideline-description { color: #6b7280; line-height: 1.5; }
        .guideline-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; margin-left: auto; padding: 0.25rem; }
        .guideline-delete-btn:hover { color: #ef4444; }

        /* --- English Quiz and BrainFlip Game Styles --- */
        .quiz-nav-button {
            background-color: #F1D24B; color: #44403c; border: none; padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 600; cursor: pointer; transition: background-color 0.2s;
        }
        .quiz-nav-button:hover {
            background-color: #eab308;
        }

        /* BrainFlip Flashcard Styles */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 400px;
            height: 250px;
            margin: 0 auto;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background-color: #ffffff;
            border: 2px solid #84C7DF;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #44403c;
            line-height: 1.4;
        }
        .flashcard-front {
            background: linear-gradient(135deg, #F1D24B 0%, #FF5C3D 100%);
        }
        .flashcard-back {
            background: linear-gradient(135deg, #84C7DF 0%, #8671D1 100%);
            transform: rotateY(180deg);
            color: white;
        }
        .navigation-button-game {
            background-color: #F1D24B;
            color: #44403c;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .navigation-button-game:hover {
            background-color: #eab308;
        }
        .navigation-button-game:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <!-- Login, Pending, and Hub Views -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <!-- O conteúdo do login será gerado pelo JS -->
    </div>

    <div id="pending-view" class="hidden items-center justify-center min-h-screen">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-yellow-500">Aguardando Aprovação</h2>
            <p class="text-stone-600 mt-2">Sua conta foi criada e está aguardando aprovação de um administrador.</p>
            <button id="pending-logout" class="mt-6 secondary-btn w-auto">Sair</button>
        </div>
    </div>

    <div id="hub-view" class="hidden">
        <div id="app-container" class="min-h-screen md:flex bg-stone-50 pt-24 md:pt-0">
            <aside class="md:w-64 bg-white md:border-r border-b border-stone-200 p-4 md:p-6 flex flex-col">
                <div class="mb-4 text-center">
                    <img id="profile-picture" src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Foto de Perfil" class="w-24 h-24 mx-auto rounded-full object-cover border-4 border-stone-200">
                </div>
                <h1 class="text-xl font-bold text-stone-800 text-center">Hub SLAP</h1>
                <p id="welcome-message" class="text-center text-sm text-stone-600 mb-6"></p>
                <nav id="main-navigation" class="space-y-1 flex-1">
                    <!-- Menu items are dynamically generated here -->
                </nav>
                <div class="mt-auto pt-4">
                    <button id="logout-button" class="nav-item w-full text-left px-4 py-2.5 rounded-lg text-stone-700 hover:bg-red-50 hover:text-red-600 transition-colors flex items-center font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Sair
                    </button>
                </div>
            </aside>
        
            <main class="flex-1 p-4 sm:p-6 md:p-8">
                <div class="bg-[#F1D24B] fixed top-0 left-0 right-0 z-50 p-4 sm:p-6 md:p-8 shadow-lg md:left-64">
                    <div class="flex justify-between items-start">
                        <header id="main-header" class="flex items-center gap-4">
                            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1751163691/SLAP_TIPO_PRETO_1_xarnpe.png" alt="SLAP Logo" class="h-12 w-auto">
                            <div>
                                <h2 id="main-title" class="text-3xl font-bold text-stone-800"></h2>
                                <p id="main-description" class="mt-1 text-stone-700"></p>
                            </div>
                        </header>
                        <div id="header-welcome-message" class="text-right text-stone-800">
                            <!-- Welcome message will be inserted here -->
                        </div>
                    </div>
                </div>
                <div id="content-area" class="mt-32"></div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="form-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-header-container" class="modal-header">
                <h4 id="form-modal-title"></h4>
                <button class="modal-close-btn" data-action="close-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="form-modal-content-area"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, serverTimestamp, query, setDoc, getDoc, updateDoc, orderBy, limit, where, arrayUnion, arrayRemove, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

        // --- GLOBAL VARIABLES ---
        const contentArea = document.getElementById('content-area');
        const mainHeader = document.getElementById('main-header');
        const loginView = document.getElementById('login-view');
        const hubView = document.getElementById('hub-view');
        const pendingView = document.getElementById('pending-view');
        
        let db, auth, storage, userId, currentUserName, currentUserRole;
        let usersData = [], students = [], turmas = [], vips = [], attendance = [], tasks = [], events = [], budgets = [], collaborators = [], schedules = [], expenses = [], cancellations = [], photos = [], photoFolders = [], cps = [], dojoRanking = [], dojoMissions = [];
        let allUnsubscribers = [];
        const appId = 'hub-gestao-slap';

        // --- DEVELOPMENT MODE FUNCTIONS ---
        function startAppInDevelopmentMode() {
            window.isDevelopmentMode = true;
            // Set up basic user data for development
            currentUserName = "Admin SLAP";
            currentUserRole = "admin";
            userId = "demo-user";
            
            // Set profile picture
            document.getElementById('profile-picture').src = 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg';
            
            // Initialize with demo data
            loadDemoData();
            updateWelcomeMessages(currentUserName);
            showHubView();
            renderInicioSection();
            renderMenu();
        }
        
        function loadDemoData() {
            // Load demo data from localStorage or create default data
            students = JSON.parse(localStorage.getItem('demo-students') || '[]');
            turmas = JSON.parse(localStorage.getItem('demo-turmas') || '[]');
            vips = JSON.parse(localStorage.getItem('demo-vips') || '[]');
            tasks = JSON.parse(localStorage.getItem('demo-tasks') || '[]');
            events = JSON.parse(localStorage.getItem('demo-events') || '[]');
            budgets = JSON.parse(localStorage.getItem('demo-budgets') || '[]');
            collaborators = JSON.parse(localStorage.getItem('demo-collaborators') || '[]');
            expenses = JSON.parse(localStorage.getItem('demo-expenses') || '[]');
            cancellations = JSON.parse(localStorage.getItem('demo-cancellations') || '[]');
            cps = JSON.parse(localStorage.getItem('demo-cps') || '[]');
            
            // Initialize with sample data if empty
            if (students.length === 0) {
                students = [
                    { id: '1', name: 'Maria Silva', email: 'maria@exemplo.com', phone: '(11) 98765-4321', status: 'ativo', setor: 'financeiro' },
                    { id: '2', name: 'João Santos', email: 'joao@exemplo.com', phone: '(11) 87654-3210', status: 'ativo', setor: 'pedagogico' }
                ];
                localStorage.setItem('demo-students', JSON.stringify(students));
            }
        }

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                    ? JSON.parse(__firebase_config)
                    : (typeof window.firebaseConfig !== 'undefined' ? window.firebaseConfig : {});

                if (!firebaseConfig.apiKey) {
                    console.warn("Configuração do Firebase não encontrada. Executando em modo de desenvolvimento local.");
                    // Initialize in development mode with localStorage
                    window.isDevelopmentMode = true;
                    startAppInDevelopmentMode();
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        await initializeAppWithUser(user);
                    } else {
                        showLoginView();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        async function initializeAppWithUser(user) {
            userId = user.uid;
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                currentUserName = userData.name || user.displayName;
                currentUserRole = userData.role;
                document.getElementById('profile-picture').src = userData.photoURL || 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg';
                
                if (['admin', 'am', 'ap', 'pedagogico', 'financeiro', 'teacher'].includes(currentUserRole)) {
                    setupFirestoreListeners();
                    showHubView();
                } else {
                    showPendingView();
                }
            } else {
                showPendingView();
            }
        }
        
        // --- FIRESTORE LISTENERS ---
        function setupFirestoreListeners() {
            if (!db || !userId) return;
            allUnsubscribers.forEach(unsub => unsub && unsub());
            allUnsubscribers = [];

            const getCollectionListener = (collectionName, targetArray, renderFunc, q) => {
                const collRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                const finalQuery = q ? q(collRef) : query(collRef);
                const unsubscribe = onSnapshot(finalQuery, (snapshot) => {
                    targetArray.length = 0;
                    snapshot.docs.forEach(doc => targetArray.push({ id: doc.id, ...doc.data() }));
                    
                    const activePageId = contentArea.firstElementChild?.id;
                    if (renderFunc && activePageId) {
                        const pageBaseName = activePageId.replace('-section', '');
                         if (pageBaseName.startsWith(collectionName.slice(0, -1).replace('_', '-').toLowerCase()) || pageBaseName === 'inicio') {
                            renderFunc();
                        }
                    }
                }, (error) => console.error(`Error on ${collectionName} listener:`, error));
                allUnsubscribers.push(unsubscribe);
            };
            
            getCollectionListener('users', usersData, null);
            getCollectionListener('students', students, () => {
                if (contentArea.firstElementChild?.id === 'alunos-section') renderAlunosSection();
                if (contentArea.firstElementChild?.id === 'turmas-section') renderTurmasSection();
                if (contentArea.firstElementChild?.id === 'vips-section') renderVipsSection();
            });
            getCollectionListener('turmas', turmas, renderTurmasSection);
            getCollectionListener('vips', vips, renderVipsSection);
            getCollectionListener('attendance', attendance, () => {
                const activeModal = document.querySelector('.modal-overlay.visible');
                if (activeModal && activeModal.querySelector('[data-pef-modal="true"]')) {
                    const pefType = activeModal.dataset.pefType;
                    const unitId = activeModal.dataset.unitId;
                    if (pefType === 'turma') {
                        openTurmaPefModal(unitId);
                    } else if (pefType === 'vip') {
                        openVipPefModal(unitId);
                    }
                }
            });
            getCollectionListener('tasks', tasks, renderTarefasSection);
            getCollectionListener('budgets', budgets, renderOrcamentosSection);
            getCollectionListener('collaborators', collaborators, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'grade-section') renderGradeSection();
                if (activePageId === 'tasks-section') renderTarefasSection();
                if (activePageId === 'colaboradores-section') renderColaboradoresSection();
                if (activePageId === 'banco-de-fotos-section') renderBancoDeFotosSection();
                if (activePageId === 'inicio-section') renderInicioSection();
            });
            getCollectionListener('events', events, renderEventosSection);
            getCollectionListener('schedules', schedules, () => {
                 if (contentArea.firstElementChild?.id === 'grade-section') renderGradeSection();
            });
            getCollectionListener('expenses', expenses, renderFolhaPagamentoSection);
            getCollectionListener('cancellations', cancellations, renderCancelamentosSection);
            getCollectionListener('photo_bank', photos, () => renderBancoDeFotosSection(document.getElementById('banco-de-fotos-section')?.dataset.currentFolder));
            getCollectionListener('photo_folders', photoFolders, () => renderBancoDeFotosSection());
            getCollectionListener('cps', cps, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'cps-section') renderCPsSection();
                if (['alunos-section', 'turmas-section', 'vips-section', 'grade-section'].includes(activePageId)) {
                    document.querySelector(`#main-navigation [data-target="${activePageId.replace('-section', '')}"]`)?.click();
                }
            }, (ref) => query(ref, orderBy("order")));
            getCollectionListener('dojo_ranking', dojoRanking, renderDojoSection);
            getCollectionListener('dojo_missions', dojoMissions, renderDojoSection, (ref) => query(ref, orderBy("points", "desc")));
        }

        // --- AUTH, VIEW, and MENU FUNCTIONS ---
        function showLoginView() {
            hubView.classList.add('hidden');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            loginView.classList.remove('hidden');
            loginView.classList.add('flex');
            loginView.innerHTML = `
                <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-lg">
                    <div class="text-center">
                        <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Logo SLAP" class="w-24 h-auto mx-auto rounded-lg mb-4">
                        <h2 class="text-2xl font-bold text-stone-900">Acesse sua conta</h2>
                        <p class="mt-2 text-sm text-stone-600">Bem-vindo(a) de volta!</p>
                    </div>
                    <form id="login-form" class="mt-8 space-y-6">
                        <div>
                            <label for="login-email" class="sr-only">E-mail</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="form-input" placeholder="Endereço de e-mail">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">Senha</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="form-input" placeholder="Senha">
                        </div>
                        <p id="login-error" class="text-sm text-red-600 text-center"></p>
                        <div>
                            <button type="submit" class="primary-btn">Entrar</button>
                        </div>
                    </form>
                    <p class="text-sm text-center text-stone-600">
                        Não tem uma conta?
                        <button data-action="open-signup" class="font-medium text-yellow-600 hover:text-yellow-500">Cadastre-se</button>
                    </p>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function showHubView() { 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            hubView.classList.remove('hidden'); 
            const firstName = (currentUserName || '').split(' ')[0];
            document.getElementById('welcome-message').textContent = `Bem-vindo(a), ${firstName}`;
            renderMenu(); 
            renderInicioSection(); 
            setActiveNavItem(document.querySelector('[data-target="inicio"]')); 
        }
        function showPendingView() { 
            hubView.classList.add('hidden'); 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.remove('hidden'); 
            pendingView.classList.add('flex');
        }
        function setActiveNavItem(element) { document.querySelectorAll('#main-navigation .nav-item').forEach(item => item.classList.remove('active')); if (element) element.classList.add('active'); }
        async function handleLogin(event) {
            event.preventDefault();
            const email = event.target.email.value;
            const password = event.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                const errorElement = document.getElementById('login-error');
                if(errorElement) errorElement.textContent = "E-mail ou senha inválidos.";
            }
        }
        async function handleSignUp(event) { event.preventDefault(); const name = event.target.name.value; const email = event.target.email.value; const password = event.target.password.value; try { const cred = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(cred.user, { displayName: name }); await setDoc(doc(db, "users", cred.user.uid), { name, email, role: "pending", createdAt: serverTimestamp() }); await signOut(auth); showSuccessMessage("Cadastro Concluído!", "Sua conta foi criada. Aguarde aprovação de um administrador para acessar."); } catch (error) { showErrorMessage("Erro", "Erro ao criar conta. Verifique o e-mail e a senha."); } }
        async function handleLogout() { 
            await signOut(auth);
        }

        // --- CONTENT RENDERING ---
        function renderInicioSection() {
            document.getElementById('main-title').textContent = 'Dashboard';
            document.getElementById('main-description').textContent = 'Visão geral das suas atividades e da equipe.';
            
            // Calculate statistics
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'Ativo').length;
            const totalTurmas = turmas.length;
            const totalRevenue = students.reduce((sum, s) => sum + (parseFloat(s.amountPaid) || 0), 0);
            
            // Check if user can see financial information
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);
            
            contentArea.innerHTML = `
                <div id="inicio-section" class="space-y-6">
                    <!-- Welcome Header removed - now integrated in main header -->
                    
                    <!-- Compact Statistics -->
                    <div class="grid grid-cols-2 ${canViewFinancialInfo ? 'md:grid-cols-4' : 'md:grid-cols-3'} gap-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200 text-center">
                            <p class="text-2xl font-bold text-blue-600">${totalStudents}</p>
                            <p class="text-sm text-stone-600">Total Alunos</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200 text-center">
                            <p class="text-2xl font-bold text-green-600">${activeStudents}</p>
                            <p class="text-sm text-stone-600">Ativos</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200 text-center">
                            <p class="text-2xl font-bold text-purple-600">${totalTurmas}</p>
                            <p class="text-sm text-stone-600">Turmas</p>
                        </div>
                        ${canViewFinancialInfo ? `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200 text-center">
                            <p class="text-2xl font-bold text-yellow-600">R$ ${totalRevenue.toFixed(0)}</p>
                            <p class="text-sm text-stone-600">Receita</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Employee Highlight Section -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-stone-800">Destaque do Mês</h4>
                            ${currentUserRole === 'admin' ? `
                            <button class="secondary-btn w-auto" data-action="edit-monthly-highlight">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                Editar
                            </button>
                            ` : ''}
                        </div>
                        <div id="monthly-highlight-content">
                            <!-- Monthly highlight content will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Quick Actions Grid -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                        <h4 class="text-lg font-bold text-stone-800 mb-4">Acesso Rápido</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button class="p-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-center transition-colors nav-item" data-target="alunos">
                                <svg class="w-6 h-6 text-blue-600 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <p class="text-xs font-medium text-blue-700">Alunos</p>
                            </button>
                            <button class="p-3 bg-green-50 hover:bg-green-100 rounded-lg text-center transition-colors nav-item" data-target="turmas">
                                <svg class="w-6 h-6 text-green-600 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                                <p class="text-xs font-medium text-green-700">Turmas</p>
                            </button>
                            <button class="p-3 bg-purple-50 hover:bg-purple-100 rounded-lg text-center transition-colors nav-item" data-target="calendario">
                                <svg class="w-6 h-6 text-purple-600 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <p class="text-xs font-medium text-purple-700">Calendário</p>
                            </button>
                            <button class="p-3 bg-orange-50 hover:bg-orange-100 rounded-lg text-center transition-colors nav-item" data-target="diretrizes">
                                <svg class="w-6 h-6 text-orange-600 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-xs font-medium text-orange-700">Diretrizes</p>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize monthly highlight
            renderMonthlyHighlight();
        }
        
        function initializeChart() {
            const ctx = document.getElementById('studentsChart');
            if (!ctx) return;
            
            const statusCounts = students.reduce((acc, student) => {
                const status = student.status || 'Pendente';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#10B981', // Green for Ativo
                            '#EF4444', // Red for Cancelado
                            '#F59E0B', // Yellow for Pendente
                            '#8B5CF6', // Purple for others
                            '#06B6D4'  // Cyan for others
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderAlunosSection() {
            document.getElementById('main-title').textContent = 'Gestão de Alunos';
            document.getElementById('main-description').textContent = 'Cadastre e gerencie todos os alunos da escola.';
            const canAdd = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);

            const totalCount = students.length;
            const activeCount = students.filter(s => s.status === 'Ativo').length;
            const cancelledCount = students.filter(s => s.status === 'Cancelado').length;

            contentArea.innerHTML = `
                <section id="alunos-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="bg-stone-100 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-stone-800">${totalCount}</p>
                            <p class="text-sm text-stone-600">Total de Alunos</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-green-700">${activeCount}</p>
                            <p class="text-sm text-green-600">Alunos Ativos</p>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-red-700">${cancelledCount}</p>
                            <p class="text-sm text-red-600">Alunos Cancelados</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <input type="search" id="aluno-search" placeholder="Pesquisar por nome..." class="form-input w-full sm:w-1/2">
                    </div>

                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="flex gap-2" id="alunos-filter-buttons">
                            <button class="secondary-btn filter-btn active" data-filter="todos">Todos</button>
                            <button class="secondary-btn filter-btn" data-filter="ativo">Ativos</button>
                            <button class="secondary-btn filter-btn" data-filter="cancelado">Cancelados</button>
                        </div>
                        <div class="flex gap-2">
                            <button class="secondary-btn w-auto" data-action="export-alunos-doc">Exportar Documento</button>
                            ${canAdd ? `<button class="primary-btn w-auto" data-action="add-aluno">+ Adicionar Aluno</button>` : ''}
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table" id="alunos-table">
                            <thead>
                                <tr>
                                    <th>Nome do Aluno</th>
                                    <th>Status</th>
                                    ${canViewFinancialInfo ? '<th>Valor Pago</th>' : ''}
                                    <th>Responsável</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="alunos-list"></tbody>
                        </table>
                    </div>
                </section>
            `;
            
            const searchInput = document.getElementById('aluno-search');
            const filterButtons = document.querySelectorAll('#alunos-filter-buttons .filter-btn');

            const performUpdate = () => {
                const currentFilter = document.querySelector('#alunos-filter-buttons .filter-btn.active').dataset.filter;
                updateAlunosList(currentFilter);
            };

            searchInput.addEventListener('input', performUpdate);
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    performUpdate();
                });
            });

            updateAlunosList('todos');
        }

        function updateAlunosList(filter) {
            const listBody = document.getElementById('alunos-list');
            if (!listBody) return;
            const canEdit = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);
            const searchTerm = document.getElementById('aluno-search')?.value.toLowerCase() || '';

            let filteredStudents = students;
            if (filter !== 'todos') {
                filteredStudents = students.filter(s => s.status && s.status.toLowerCase() === filter);
            }

            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchTerm));
            }

            // Sort students alphabetically by name
            filteredStudents.sort((a, b) => a.name.localeCompare(b.name));

            if (filteredStudents.length === 0) {
                const colspanCount = canViewFinancialInfo ? 5 : 4;
                listBody.innerHTML = `<tr><td colspan="${colspanCount}" class="text-center py-10 text-stone-500">Nenhum aluno encontrado.</td></tr>`;
                return;
            }

            listBody.innerHTML = filteredStudents.map(student => `
                <tr data-action="view-aluno" data-id="${student.id}" class="cursor-pointer">
                    <td class="font-medium">${student.name}</td>
                    <td><span class="status-tag status-${(student.status || 'pendente').toLowerCase()}">${student.status || 'Pendente'}</span></td>
                    ${canViewFinancialInfo ? `<td class="font-mono">R$ ${parseFloat(student.amountPaid || 0).toFixed(2)}</td>` : ''}
                    <td>${student.responsibleName || 'N/A'}</td>
                    <td class="text-center">
                         ${canEdit ? `<button class="secondary-btn" data-action="edit-aluno" data-id="${student.id}" onclick="event.stopPropagation()">Editar</button>` : `<button class="secondary-btn" data-action="view-aluno" data-id="${student.id}" onclick="event.stopPropagation()">Ver</button>`}
                    </td>
                </tr>
            `).join('');
        }

        function renderTurmasSection() {
            document.getElementById('main-title').textContent = 'Gestão de Turmas';
            document.getElementById('main-description').textContent = 'Crie turmas, adicione alunos e registre as presenças.';
            
            const canManage = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);
            let itemsToDisplay = turmas;
            if (currentUserRole === 'teacher') {
                itemsToDisplay = turmas.filter(t => t.teacherName === currentUserName);
            }

            contentArea.innerHTML = `
                <div id="turmas-section">
                    <div class="text-right mb-6">
                        ${canManage ? `<button class="primary-btn w-auto" data-action="add-turma">+ Adicionar Turma</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${itemsToDisplay.map(t => `
                        <div class="base-card flex flex-col">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-xl font-bold text-stone-800">${t.name}</h3>
                                    <span class="text-sm font-semibold text-stone-600">${(t.studentIds || []).length} aluno(s)</span>
                                </div>
                                <p class="text-sm text-stone-500 mb-2">Professor: ${t.teacherName}</p>
                                <p class="text-sm text-stone-600"><strong>Nível:</strong> ${t.level}</p>
                                <p class="text-sm text-stone-600"><strong>Semestre:</strong> ${t.semestre || 'N/A'}</p>
                            </div>
                            <div class="mt-auto pt-4 border-t border-stone-100 flex gap-2">
                                ${canManage ? `<button class="secondary-btn !text-sm flex-1" data-action="edit-turma" data-id="${t.id}">Editar</button>` : ''}
                                <button class="primary-btn !text-sm flex-1" data-action="open-turma-pef" data-id="${t.id}">PEF</button>
                            </div>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhuma turma encontrada.</p>'}
                    </div>
                </div>`;
        }

        function renderVipsSection() {
            document.getElementById('main-title').textContent = 'Gestão de VIPs';
            document.getElementById('main-description').textContent = 'Gerencie alunos VIP e registre suas presenças.';
            
            const canManage = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);
            let itemsToDisplay = vips;
            if (currentUserRole === 'teacher') {
                itemsToDisplay = vips.filter(v => v.teacherName === currentUserName);
            }

            contentArea.innerHTML = `
                <div id="vips-section">
                    <div class="text-right mb-6">
                        ${canManage ? `<button class="primary-btn w-auto" data-action="add-vip">+ Adicionar VIP</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${itemsToDisplay.map(v => `
                        <div class="base-card flex flex-col">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-xl font-bold text-stone-800">${v.studentName}</h3>
                                    <span class="status-tag tag-vip !text-white">VIP</span>
                                </div>
                                <p class="text-sm text-stone-500 mb-2">Professor: ${v.teacherName}</p>
                                <p class="text-sm text-stone-600"><strong>Nível:</strong> ${v.level}</p>
                                <p class="text-sm text-stone-600"><strong>Semestre:</strong> ${v.semestre || 'N/A'}</p>
                            </div>
                            <div class="mt-auto pt-4 border-t border-stone-100 flex gap-2">
                                ${canManage ? `<button class="secondary-btn !text-sm flex-1" data-action="edit-vip" data-id="${v.id}">Editar</button>` : ''}
                                <button class="primary-btn !text-sm flex-1" data-action="open-vip-pef" data-id="${v.id}">PEF</button>
                            </div>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhum aluno VIP encontrado.</p>'}
                    </div>
                </div>`;
        }

        function renderEventosSection() {
            document.getElementById('main-title').textContent = 'Gestor de Eventos';
            document.getElementById('main-description').textContent = 'Planeje e gerencie todos os eventos da marca.';
            contentArea.innerHTML = `
                <div id="events-section">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-event">+ Adicionar Evento</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${events.map(e => `
                        <div class="base-card cursor-pointer" data-action="view-event" data-id="${e.id}">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-stone-800">${e.nome}</h3>
                                ${e.setor ? `<span class="status-tag status-${e.setor.toLowerCase()}">${e.setor}</span>` : ''}
                            </div>
                            <p class="text-sm text-stone-500 mb-4">Data: ${new Date(e.data + 'T00:00:00').toLocaleDateString('pt-BR')} ${e.time ? `às ${e.time}`: ''}</p>
                            <p class="text-sm text-stone-600 truncate"><strong>Local:</strong> ${e.local}</p>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhum evento encontrado.</p>'}
                    </div>
                </div>`;
        }

        function renderOrcamentosSection() { document.getElementById('main-title').textContent = 'Gestor de Orçamentos'; document.getElementById('main-description').textContent = 'Registre e acompanhe todas as propostas e orçamentos.'; contentArea.innerHTML = `<div id="budgets-section"><div class="text-right mb-6"><button class="primary-btn w-auto" data-action="add-budget">+ Adicionar Orçamento</button></div><div class="space-y-4">${budgets.map(b => `<div class="base-card flex flex-wrap justify-between items-center gap-4 cursor-pointer" data-action="view-budget" data-id="${b.id}"><div class="flex-1"><h3 class="text-lg font-bold text-stone-800">${b.titulo}</h3><p class="text-sm text-stone-500">Feito por: ${b.criadoPor || 'N/A'} em ${b.dataCriacao ? new Date(b.dataCriacao).toLocaleDateString('pt-BR') : 'N/A'}</p></div><div class="text-right"><p class="text-xl font-bold text-stone-800">R$ ${parseFloat(b.valor || 0).toFixed(2)}</p><span class="status-tag status-${b.status.toLowerCase()}">${b.status}</span></div></div>`).join('') || '<p class="text-center py-10 text-stone-500">Nenhum orçamento encontrado.</p>'}</div></div>`; }
        
        function renderTarefasSection() { 
            document.getElementById('main-title').textContent = 'Lista de Tarefas'; 
            document.getElementById('main-description').textContent = 'Gerencie e acompanhe as tarefas da equipe.'; 
            
            const collaboratorOptions = collaborators.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            contentArea.innerHTML = `
                <div id="tasks-section">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="grade-select-container flex-grow">
                             <label for="task-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por colaborador:</label>
                             <select id="task-filter" class="grade-select">
                                <option value="all">Todos</option>
                                ${collaboratorOptions}
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button class="primary-btn w-auto" data-action="add-task">+ Adicionar Tarefa</button>
                        </div>
                    </div>
                    <div id="task-list-container" class="space-y-4"></div>
                </div>`; 
            document.getElementById('task-filter').addEventListener('change', () => updateTaskList());
            updateTaskList(); 
        }

        function updateTaskList() { 
            const container = document.getElementById('task-list-container'); 
            if (!container) return; 
            
            const filterValue = document.getElementById('task-filter')?.value || 'all';
            let filteredTasks = [...tasks]; 

            if (filterValue !== 'all') {
                filteredTasks = tasks.filter(task => task.assignedTo && task.assignedTo.includes(filterValue));
            }

            filteredTasks.sort((a, b) => a.completed - b.completed || new Date(a.deadline) - new Date(b.deadline)); 
            if (filteredTasks.length === 0) { container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg"><p class="text-stone-500">Nenhuma tarefa encontrada para este filtro.</p></div>`; return; } 
            container.innerHTML = filteredTasks.map(task => { 
                const deadlineDate = new Date(task.deadline + 'T00:00:00'); 
                const isOverdue = !task.completed && deadlineDate < new Date(); 
                const deadlineClass = isOverdue ? 'deadline-overdue' : ''; 
                const formattedDate = deadlineDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' }); 
                return `<div class="task-card flex items-start gap-4 ${task.completed ? 'completed' : ''}"><input type="checkbox" data-action="toggle-task" data-id="${task.id}" class="mt-1.5 h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${task.completed ? 'checked' : ''}><div class="flex-1"><p class="text-stone-800 font-medium">${task.description}</p><div class="mt-3 flex flex-wrap justify-between items-center gap-4"><div class="flex items-center gap-2 flex-wrap"><span class="text-xs text-stone-500">Para:</span>${(task.assignedTo || []).map(name => `<span class="user-tag" style="background-color: #e5e7eb; color: #374151;">${name}</span>`).join('')}</div><div class="text-right"><span class="text-xs text-stone-500">Prazo</span><p class="deadline-text ${deadlineClass}">${formattedDate}</p></div></div></div><button class="task-delete-btn" data-action="delete-item" data-collection="tasks" data-id="${task.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`; 
            }).join(''); 
        }
        
        function renderGradeSection() {
            document.getElementById('main-title').textContent = 'Grade de Horários';
            document.getElementById('main-description').textContent = 'Visualize e gerencie a grade de aulas da equipe.';
            
            const isTeacher = currentUserRole === 'teacher';
            let filterHtml = '';
            
            if (!isTeacher) {
                const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                filterHtml = `
                    <div class="grade-select-container flex-grow">
                        <label for="teacher-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por professor:</label>
                        <select id="teacher-filter" class="grade-select">
                            <option value="all">Todos</option>
                            ${teacherOptions}
                        </select>
                    </div>
                `;
            }

            const addAulaButton = ['admin', 'ap', 'pedagogico'].includes(currentUserRole)
                ? `<button class="primary-btn w-auto" data-action="add-schedule">+ Adicionar Aula</button>`
                : '';

            contentArea.innerHTML = `
                <section id="grade-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        ${filterHtml}
                        <div class="flex gap-2 ml-auto">
                           ${addAulaButton}
                        </div>
                    </div>
                    <div id="schedule-grid-container"></div>
                </section>
            `;

            if (isTeacher) {
                renderScheduleGrid(currentUserName);
            } else {
                document.getElementById('teacher-filter').addEventListener('change', () => renderScheduleGrid(document.getElementById('teacher-filter').value));
                renderScheduleGrid('all');
            }
        }

        function renderScheduleGrid(teacherFilter) {
            const gridContainer = document.getElementById('schedule-grid-container');
            if (!gridContainer) return;

            const days = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta"];
            let filteredSchedules = [...schedules];

            if (teacherFilter !== 'all') {
                filteredSchedules = filteredSchedules.filter(s => s.teacher === teacherFilter);
            }

            let gridHtml = `<div class="schedule-grid">`;
            days.forEach(day => {
                gridHtml += `<div class="day-column"><h3 class="day-column-header">${day}</h3>`;
                const dayClasses = filteredSchedules.filter(s => s.day === day).sort((a, b) => a.startTime.localeCompare(b.startTime));
                if (dayClasses.length > 0) {
                    dayClasses.forEach(c => {
                        const tagClass = c.type === 'vip' ? 'tag-vip' : 'tag-turma';
                        const tagText = c.type === 'vip' ? 'VIP' : 'TURMA';
                        const teacherName = teacherFilter === 'all' ? `<p class="text-xs text-stone-500"><em>(${c.teacher})</em></p>` : '';
                        
                        gridHtml += `
                            <div class="class-entry" data-action="view-schedule" data-id="${c.id}">
                                <span class="class-tag ${tagClass}">${tagText}</span>
                                <p class="text-xs text-stone-600">${c.startTime} - ${c.endTime}</p>
                                <p class="font-bold text-stone-800">${c.student}</p>
                                <p class="text-sm text-stone-700">${c.level}</p>
                                ${teacherName}
                            </div>`;
                    });
                } else {
                    gridHtml += `<p class="text-sm text-center text-stone-400 mt-4">Nenhuma aula</p>`;
                }
                gridHtml += `</div>`;
            });
            gridHtml += `</div>`;
            gridContainer.innerHTML = gridHtml;
        }

        function renderFolhaPagamentoSection() {
            document.getElementById('main-title').textContent = 'Folha de Pagamento';
            document.getElementById('main-description').textContent = 'Gerencie as despesas e contas a pagar do mês.';
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthName = now.toLocaleString('pt-BR', { month: 'long' });

            const monthlyExpenses = expenses.map(exp => {
                let dueDate;
                if (exp.isFixedSalary && exp.dueDay) {
                    const day = parseInt(exp.dueDay, 10);
                    if (day > 0 && day < 32) {
                       dueDate = new Date(currentYear, currentMonth, day);
                    }
                } else if (exp.dueDate) {
                    // Create date as UTC to avoid timezone issues with date-only strings
                    const parts = exp.dueDate.split('-');
                    dueDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                }

                if (dueDate && dueDate.getUTCMonth() === currentMonth && dueDate.getUTCFullYear() === currentYear) {
                    return { ...exp, effectiveDueDate: dueDate };
                }
                return null;
            }).filter(Boolean).sort((a, b) => a.effectiveDueDate - b.effectiveDueDate);

            const totalToPay = monthlyExpenses
                .filter(exp => !exp.isPaid)
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            contentArea.innerHTML = `
                <section id="folha-pagamento-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                         <h3 class="text-xl font-bold text-stone-800">Despesas de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>
                         <button class="primary-btn w-auto" data-action="add-expense">+ Nova Despesa</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pago</th>
                                    <th>Descrição</th>
                                    <th>Vencimento</th>
                                    <th class="text-right">Valor (R$)</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-list">
                                ${monthlyExpenses.length > 0 ? monthlyExpenses.map(exp => `
                                    <tr class="${exp.isPaid ? 'paid' : ''}">
                                        <td class="text-center"><input type="checkbox" data-action="toggle-expense" data-id="${exp.id}" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${exp.isPaid ? 'checked' : ''}></td>
                                        <td class="font-medium cursor-pointer" data-action="view-expense" data-id="${exp.id}">${exp.description} ${exp.isFixedSalary && exp.employeeRole ? `<span class="sector-tag">${exp.employeeRole}</span>` : ''}</td>
                                        <td class="cursor-pointer" data-action="view-expense" data-id="${exp.id}">${exp.effectiveDueDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                                        <td class="text-right font-mono cursor-pointer" data-action="view-expense" data-id="${exp.id}">${Number(exp.amount).toFixed(2)}</td>
                                        <td class="text-center">
                                            <button class="task-delete-btn" data-action="delete-item" data-collection="expenses" data-id="${exp.id}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" class="text-center py-8 text-stone-500">Nenhuma despesa para este mês.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    <div class="data-total">
                        <p>Total a Pagar: ${totalToPay.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                    </div>
                </section>
            `;
        }
        
        function renderCancelamentosSection() {
            document.getElementById('main-title').textContent = 'Registro de Cancelamentos';
            document.getElementById('main-description').textContent = 'Gerencie todos os cancelamentos de matrículas.';
            const canAdd = ['admin', 'financeiro'].includes(currentUserRole);
            
            contentArea.innerHTML = `
                <section id="cancellations-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                     <div class="text-right mb-6">
                         ${canAdd ? `<button class="primary-btn w-auto" data-action="add-cancelamento">+ Adicionar Cancelamento</button>` : ''}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Aluno</th>
                                    <th>Data do Cancelamento</th>
                                    <th>Motivo</th>
                                    <th>Processado Por</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cancellations.map(c => `
                                <tr class="cursor-pointer" data-action="view-cancelamento" data-id="${c.id}">
                                    <td class="font-medium">${c.studentName}</td>
                                    <td>${new Date(c.cancellationDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                    <td>${c.reason}</td>
                                    <td>${c.processedBy}</td>
                                </tr>
                                `).join('') || '<tr><td colspan="4" class="text-center py-10 text-stone-500">Nenhum cancelamento encontrado.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }
        
        function renderColaboradoresSection() {
            document.getElementById('main-title').textContent = 'Gestão de Colaboradores';
            document.getElementById('main-description').textContent = 'Adicione, edite e defina os setores de cada colaborador.';
            contentArea.innerHTML = `
                <section id="colaboradores-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-collaborator">+ Adicionar Colaborador</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Setores</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${collaborators.map(c => `
                                    <tr>
                                        <td class="font-medium">${c.name}</td>
                                        <td>${(c.sectors || []).map(s => `<span class="sector-tag">${s}</span>`).join('')}</td>
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-collaborator" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="collaborators" data-id="${c.id}">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="3" class="text-center py-10 text-stone-500">Nenhum colaborador encontrado.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        function renderBancoDeFotosSection(folderNameToOpen = null) {
            document.getElementById('main-title').textContent = 'Banco de Fotos';
            document.getElementById('main-description').textContent = 'Gerencie os recursos visuais para marketing e divulgação.';
            
            if (folderNameToOpen) {
                renderPhotoGallery(folderNameToOpen);
                return;
            }

            contentArea.innerHTML = `
                <section id="banco-de-fotos-section">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-stone-800">Pastas</h3>
                        <div class="flex gap-2">
                           <button class="secondary-btn w-auto" data-action="add-folder">+ Nova Pasta</button>
                           <button class="primary-btn w-auto" data-action="add-photo">+ Adicionar Foto</button>
                        </div>
                    </div>
                    <div class="folder-grid">
                        ${photoFolders.map(folder => `
                            <div class="folder-card" data-action="open-folder" data-folder-name="${folder.name}">
                                <button class="folder-delete-btn" data-action="delete-folder" data-id="${folder.id}" data-folder-name="${folder.name}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3 text-yellow-400"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>
                                <p class="font-semibold text-stone-700">${folder.name}</p>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function renderPhotoGallery(folderName) {
             const photosInFolder = photos.filter(p => p.folder === folderName);
             contentArea.innerHTML = `
                <section id="banco-de-fotos-section" data-current-folder="${folderName}">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <button class="secondary-btn mb-2" data-action="back-to-folders">← Voltar para Pastas</button>
                            <h3 class="text-2xl font-bold text-stone-800">Pasta: ${folderName}</h3>
                        </div>
                        <button class="primary-btn w-auto" data-action="add-photo">+ Adicionar Foto</button>
                    </div>
                    <div class="photo-grid">
                        ${photosInFolder.length > 0 ? photosInFolder.map(photo => `
                            <div class="photo-card">
                                <img src="${photo.url}" alt="${photo.title}" class="bg-stone-100">
                                <div class="photo-card-info">
                                    <p class="font-semibold text-stone-800 truncate">${photo.title}</p>
                                    <div class="mt-4 flex gap-2">
                                        <a href="${photo.url}" download="${photo.title.replace(/\s+/g, '_')}.jpg" class="primary-btn text-center text-sm py-2">Download</a>
                                        <button class="danger-btn text-sm py-2" data-action="delete-item" data-collection="photo_bank" data-id="${photo.id}">Excluir</button>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-stone-500 col-span-full text-center py-10">Nenhuma foto nesta pasta.</p>'}
                    </div>
                </section>
             `;
        }

        function renderCPsSection() {
            document.getElementById('main-title').textContent = 'Cronogramas Pedagógicos (CPs)';
            document.getElementById('main-description').textContent = 'Gerencie os níveis e aulas dos cursos.';
            const canEdit = ['pedagogico', 'ap', 'admin'].includes(currentUserRole);
            const addNivelBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-nivel">+ Adicionar Nível</button>` : '';

            contentArea.innerHTML = `
                <section id="cps-section">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <h3 class="text-xl font-bold text-stone-800">Níveis do Curso</h3>
                        <div class="flex gap-2">
                           <button class="secondary-btn w-auto" data-action="export-cps-doc">Exportar CPs</button>
                           ${addNivelBtn}
                        </div>
                    </div>
                    <div id="cp-list-container">
                        ${cps.map((nivel, index) => `
                            <div class="cp-level-card" id="nivel-${nivel.id}">
                                <div class="cp-level-header" data-action="toggle-cp-level" data-id="${nivel.id}">
                                    <h4 class="text-lg font-bold text-stone-800">${nivel.title}</h4>
                                    <div class="flex items-center gap-2">
                                        ${canEdit ? `
                                        <button class="secondary-btn text-xs p-1" data-action="reorder-cp" data-id="${nivel.id}" data-direction="up" ${index === 0 ? 'disabled' : ''}>↑</button>
                                        <button class="secondary-btn text-xs p-1" data-action="reorder-cp" data-id="${nivel.id}" data-direction="down" ${index === cps.length - 1 ? 'disabled' : ''}>↓</button>
                                        <button class="secondary-btn text-xs" data-action="add-aula" data-nivel-id="${nivel.id}">+ Aula</button>
                                        <button class="secondary-btn text-xs" data-action="edit-nivel" data-id="${nivel.id}">Editar</button>
                                        <button class="danger-btn text-xs" data-action="delete-item" data-collection="cps" data-id="${nivel.id}">X</button>` : ''}
                                        <svg class="h-6 w-6 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </div>
                                </div>
                                <div class="cp-level-content">
                                    ${(nivel.lessons && nivel.lessons.length > 0) ? nivel.lessons.map((aula, index) => `
                                        <div class="cp-lesson-item">
                                            <div>
                                                <p class="font-semibold">${index + 1}. ${aula.title}</p>
                                                <p class="text-sm text-stone-600">${aula.topic}</p>
                                                <div class="mt-2 flex flex-wrap">${(aula.keywords || []).map(k => `<span class="keyword-tag">${k}</span>`).join('')}</div>
                                            </div>
                                            ${canEdit ? `
                                            <div>
                                                <button class="secondary-btn text-xs" data-action="edit-aula" data-nivel-id="${nivel.id}" data-aula-index="${index}">Editar</button>
                                                <button class="danger-btn text-xs" data-action="delete-aula" data-nivel-id="${nivel.id}" data-aula-index="${index}">X</button>
                                            </div>
                                            ` : ''}
                                        </div>
                                    `).join('') : '<p class="text-center text-stone-500 py-4">Nenhuma aula adicionada.</p>'}
                                </div>
                            </div>
                        `).join('') || '<p class="text-center py-10 text-stone-500">Nenhum nível cadastrado.</p>'}
                    </div>
                </section>
            `;
        }
        
        function renderDojoSection() {
            document.getElementById('main-title').textContent = 'SLAP Dojo';
            document.getElementById('main-description').textContent = 'Gerencie a pontuação dos competidores e as missões ativas.';
            const canEdit = ['admin', 'ap'].includes(currentUserRole);
            const addCompetitorBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-dojo-competitor">+ Adicionar Competidor</button>` : '';
            const addMissionBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-dojo-mission">+ Adicionar Missão</button>` : '';

            const sortedRanking = [...dojoRanking].sort((a, b) => b.points - a.points);

            contentArea.innerHTML = `
                <section id="dojo-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xl font-bold text-stone-800">Ranking de Competidores</h3>
                        ${addCompetitorBtn}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10 text-center">
                        <div class="p-4 rounded-lg border-2 border-stone-300 bg-stone-50 order-2 md:order-1">
                            <h4 class="font-bold text-lg text-amber-500">🥈 2º Lugar</h4>
                            <p class="text-stone-600">Alexa Echo Dot + R$500 </p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-yellow-400 bg-yellow-50 transform md:scale-110 order-1 md:order-2">
                            <h4 class="font-bold text-lg text-yellow-500">🥇 1º Lugar</h4>
                            <p class="text-stone-700 font-semibold">R$1000 + jantar + folga</p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-amber-600 bg-stone-50 order-3 md:order-3">
                            <h4 class="font-bold text-lg text-amber-700">🥉 3º Lugar</h4>
                            <p class="text-stone-600">R$250 + mimo</p>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Competidor</th>
                                    <th class="text-right">Pontos</th>
                                    ${canEdit ? '<th class="text-center">Ações</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedRanking.map((c, index) => {
                                    const medals = ['🥇', '🥈', '🥉'];
                                    const medal = index < 3 ? `<span class="text-xl ml-2">${medals[index]}</span>` : '';
                                    return `
                                    <tr>
                                        <td class="font-bold text-stone-500 text-lg">#${index + 1}</td>
                                        <td class="flex items-center gap-3">
                                            <img src="${c.photo}" alt="${c.name}" class="w-10 h-10 rounded-full object-cover">
                                            <span class="font-medium">${c.name}</span>
                                            ${medal}
                                        </td>
                                        <td class="text-right font-mono font-semibold">${c.points || 0}</td>
                                        ${canEdit ? `
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-dojo-points" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="dojo_ranking" data-id="${c.id}">X</button>
                                        </td>
                                        ` : ''}
                                    </tr>
                                `}).join('') || '<tr><td colspan="4" class="text-center py-10 text-stone-500">Nenhum competidor no Dojo.</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <!-- Missões Ativas Section -->
                    <div class="mt-12 pt-8 border-t border-stone-200">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-stone-800">Missões Ativas</h3>
                            ${addMissionBtn}
                        </div>
                        <div id="dojo-missions-list" class="space-y-3">
                            ${dojoMissions.length > 0 ? dojoMissions.map(mission => `
                                <div class="base-card !p-4 flex justify-between items-center">
                                    <p class="font-medium text-stone-700 flex-1 pr-4">${mission.description}</p>
                                    <div class="flex items-center gap-4">
                                        <span class="font-bold text-lg text-yellow-500 whitespace-nowrap">${mission.points} pts</span>
                                        ${canEdit ? `<button class="danger-btn !text-xs !py-1 !px-2" data-action="delete-item" data-collection="dojo_missions" data-id="${mission.id}">Excluir</button>` : ''}
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center p-8 bg-stone-50 rounded-lg"><p class="text-stone-500">Nenhuma missão ativa no momento.</p></div>'}
                        </div>
                    </div>
                </section>
            `;
        }


        // --- MODAL & FORM FUNCTIONS ---
        function clearModalHeaderButtons() {
            const header = document.getElementById('modal-header-container');
            const title = header.querySelector('#form-modal-title');
            const closeBtn = header.querySelector('.modal-close-btn');
            header.innerHTML = '';
            header.appendChild(title);
            header.appendChild(closeBtn);
        }
        function closeFormModal() { 
            const modal = document.getElementById('form-modal');
            modal.classList.remove('visible'); 
            clearModalHeaderButtons();
            // Clear attributes to prevent listener conflicts
            modal.removeAttribute('data-pef-modal');
            modal.removeAttribute('data-unit-id');
            modal.removeAttribute('data-pef-type');
            modal.removeAttribute('data-student-name');
        }
        function showSuccessMessage(title, message) { clearModalHeaderButtons(); const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; document.getElementById('form-modal').classList.add('visible'); }
        function showErrorMessage(title, message) { clearModalHeaderButtons(); const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; document.getElementById('form-modal').classList.add('visible'); }
        function showConfirmationModal(title, message, onConfirm) { clearModalHeaderButtons(); const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<p class="text-stone-600">${message}</p><div class="mt-6 flex justify-end gap-4"><button class="secondary-btn" data-action="close-modal">Cancelar</button><button id="confirm-action-btn" class="danger-btn w-auto">Confirmar</button></div>`; document.getElementById('form-modal').classList.add('visible'); document.getElementById('confirm-action-btn').onclick = () => { onConfirm(); closeFormModal(); }; }
        
        function openSignUpModal() {
            clearModalHeaderButtons();
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');
            
            modalTitle.textContent = "Criar Nova Conta";
            modalContentArea.innerHTML = `
                <form id="signup-form" class="space-y-4">
                    <div><label for="signup-name" class="font-medium text-sm">Nome Completo</label><input type="text" id="signup-name" name="name" required class="form-input mt-1"></div>
                    <div><label for="signup-email" class="font-medium text-sm">E-mail</label><input type="email" id="signup-email" name="email" required class="form-input mt-1"></div>
                    <div><label for="signup-password" class="font-medium text-sm">Senha (mín. 6 caracteres)</label><input type="password" id="signup-password" name="password" required class="form-input mt-1"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Cadastrar</button></div>
                </form>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            document.getElementById('form-modal').classList.add('visible');
        }

        function openAlunoForm(alunoId = null) {
            clearModalHeaderButtons();
            const aluno = alunoId ? students.find(s => s.id === alunoId) : null;
            document.getElementById('form-modal-title').textContent = aluno ? "Editar Aluno" : "Adicionar Novo Aluno";
            
            const statusOptions = ['Ativo', 'Inativo', 'Cancelado', 'Pendente'].map(s => `<option value="${s}" ${aluno?.status === s ? 'selected' : ''}>${s}</option>`).join('');
            const paymentTypeOptions = ['Cartão', 'Boleto', 'Permuta', 'Bolsa'].map(p => `<option value="${p}" ${aluno?.paymentType === p ? 'selected' : ''}>${p}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="aluno-id" value="${alunoId || ''}">
                    
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2">Informações Básicas</h4>
                    <div><label class="font-medium text-sm">Nome Completo do Aluno</label><input type="text" id="aluno-name" class="form-input" required value="${aluno?.name || ''}"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Status</label><select id="aluno-status" class="form-input">${statusOptions}</select></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="aluno-startDate" class="form-input" value="${aluno?.startDate || ''}"></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Níveis Cursados</label>
                        <div id="aluno-levels-checkboxes" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 max-h-40 overflow-y-auto p-2 border rounded-md">
                            ${cps.map(cp => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="level-${cp.id}" name="completedLevels" value="${cp.title}" class="h-4 w-4 rounded text-yellow-500 focus:ring-yellow-400" ${aluno?.completedLevels?.includes(cp.title) ? 'checked' : ''}>
                                    <label for="level-${cp.id}" class="ml-2 text-sm">${cp.title}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Informações Financeiras</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Tipo de Pagamento</label><select id="aluno-paymentType" class="form-input">${paymentTypeOptions}</select></div>
                        <div><label class="font-medium text-sm">Valor Pago (R$)</label><input type="number" step="0.01" id="aluno-amountPaid" class="form-input" value="${aluno?.amountPaid || ''}"></div>
                        <div><label class="font-medium text-sm">Valor Recebido (R$)</label><input type="number" step="0.01" id="aluno-amountReceived" class="form-input" value="${aluno?.amountReceived || ''}"></div>
                    </div>

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Responsável</h4>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="aluno-isMinor" class="h-4 w-4 rounded" ${aluno?.isMinor ? 'checked' : ''}>
                        <label for="aluno-isMinor" class="text-sm font-medium">Menor de idade?</label>
                    </div>
                    <div id="responsible-fields" class="${aluno?.isMinor ? '' : 'hidden'} space-y-4">
                        <div><label class="font-medium text-sm">Nome do Responsável</label><input type="text" id="aluno-responsibleName" class="form-input" value="${aluno?.responsibleName || ''}"></div>
                        <div><label class="font-medium text-sm">Telefone do Responsável</label><input type="tel" id="aluno-responsiblePhone" class="form-input" value="${aluno?.responsiblePhone || ''}"></div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Outras Informações</h4>
                    <div><label class="font-medium text-sm">Observações</label><textarea id="aluno-notes" rows="3" class="form-input">${aluno?.notes || ''}</textarea></div>
                    
                    <div class="text-right pt-4"><button type="submit" class="primary-btn w-auto">Salvar Aluno</button></div>
                </form>
            `;

            document.getElementById('aluno-isMinor').addEventListener('change', (e) => {
                document.getElementById('responsible-fields').classList.toggle('hidden', !e.target.checked);
            });

            document.getElementById('form-modal-body').onsubmit = saveAluno;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveAluno(event) {
            event.preventDefault();
            const alunoId = document.getElementById('aluno-id').value;
            const isMinor = document.getElementById('aluno-isMinor').checked;
            
            const completedLevels = Array.from(document.querySelectorAll('input[name="completedLevels"]:checked')).map(cb => cb.value);

            const data = {
                name: document.getElementById('aluno-name').value,
                status: document.getElementById('aluno-status').value,
                startDate: document.getElementById('aluno-startDate').value,
                completedLevels: completedLevels,
                paymentType: document.getElementById('aluno-paymentType').value,
                amountPaid: document.getElementById('aluno-amountPaid').value,
                amountReceived: document.getElementById('aluno-amountReceived').value,
                notes: document.getElementById('aluno-notes').value,
                isMinor: isMinor,
                responsibleName: isMinor ? document.getElementById('aluno-responsibleName').value : '',
                responsiblePhone: isMinor ? document.getElementById('aluno-responsiblePhone').value : '',
            };
            if (!data.name) { showErrorMessage("Erro", "O nome do aluno é obrigatório."); return; }

            try {
                if (alunoId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, alunoId), data);
                    showSuccessMessage("Sucesso!", "Dados do aluno atualizados.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/students`), data);
                    showSuccessMessage("Sucesso!", "Novo aluno cadastrado.");
                }
            } catch (error) {
                console.error("Error saving student:", error);
                showErrorMessage("Erro", "Falha ao salvar os dados do aluno.");
            }
        }

        function openAlunoModal(alunoId) {
            clearModalHeaderButtons();
            const aluno = students.find(s => s.id === alunoId);
            if (!aluno) return;
            document.getElementById('form-modal-title').textContent = `Perfil de ${aluno.name}`;
            const canEdit = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            
            let responsibleHtml = '';
            if (aluno.isMinor && aluno.responsibleName) {
                responsibleHtml = `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-stone-700">Dados do Responsável</h4>
                        <p class="text-sm text-stone-600 mt-1"><strong>Nome:</strong> ${aluno.responsibleName || 'N/A'}</p>
                        <p class="text-sm text-stone-600"><strong>Telefone:</strong> ${aluno.responsiblePhone || 'N/A'}</p>
                    </div>
                `;
            }

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-stone-800">${aluno.name}</h3>
                        <span class="status-tag status-${(aluno.status || 'pendente').toLowerCase()}">${aluno.status || 'Pendente'}</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm text-stone-600">
                        <p><strong>Início:</strong> ${aluno.startDate ? new Date(aluno.startDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                        <p><strong>Pagamento:</strong> ${aluno.paymentType || 'N/A'}</p>
                        <p><strong>Valor Pago:</strong> R$ ${parseFloat(aluno.amountPaid || 0).toFixed(2)}</p>
                        <p><strong>Valor Recebido:</strong> R$ ${parseFloat(aluno.amountReceived || 0).toFixed(2)}</p>
                    </div>

                    <div class="pt-2">
                        <p class="font-semibold text-sm text-stone-700">Níveis Cursados:</p>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${(aluno.completedLevels && aluno.completedLevels.length > 0) ? aluno.completedLevels.map(level => `<span class="keyword-tag !m-0">${level}</span>`).join('') : '<span class="text-sm text-stone-500">Nenhum</span>'}
                        </div>
                    </div>
                    
                    ${responsibleHtml}

                    ${aluno.notes ? `<div class="mt-4 pt-4 border-t"><strong>Observações:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md whitespace-pre-wrap text-sm">${aluno.notes}</p></div>` : ''}
                    
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEdit ? `<button class="secondary-btn" data-action="edit-aluno" data-id="${aluno.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="students" data-id="${aluno.id}">Apagar</button>` : ''}
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openTurmaForm(turmaId = null) {
            clearModalHeaderButtons();
            const turma = turmaId ? turmas.find(t => t.id === turmaId) : null;
            document.getElementById('form-modal-title').textContent = turma ? "Editar Turma" : "Adicionar Nova Turma";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${turma?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = cps.map(cp => `<option value="${cp.title}" ${turma?.level === cp.title ? 'selected' : ''}>${cp.title}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;
            
            const studentCheckboxes = students
                .filter(s => s.status === 'Ativo')
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(s => `
                    <div class="flex items-center">
                        <input type="checkbox" id="student-${s.id}" value="${s.id}" name="turma-students" class="h-4 w-4 rounded" ${(turma?.studentIds || []).includes(s.id) ? 'checked' : ''}>
                        <label for="student-${s.id}" class="ml-2 text-sm">${s.name}</label>
                    </div>
                `).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="turma-id" value="${turmaId || ''}">
                    <div><label class="font-medium text-sm">Nome da Turma</label><input type="text" id="turma-name" class="form-input" required value="${turma?.name || ''}"></div>
                    <div><label class="font-medium text-sm">Professor</label><select id="turma-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div>
                        <label class="font-medium text-sm">Nível</label>
                        <select id="turma-level" class="form-input" required>${levelOptions}</select>
                        <input type="text" id="turma-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Semestre</label><input type="text" id="turma-semestre" class="form-input" value="${turma?.semestre || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="turma-startDate" class="form-input" value="${turma?.startDate || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Finalização</label><input type="date" id="turma-endDate" class="form-input" value="${turma?.endDate || ''}"></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Alunos</label>
                        <div id="turma-students-checkboxes" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 max-h-48 overflow-y-auto p-3 border rounded-md bg-stone-50">
                            ${studentCheckboxes}
                        </div>
                    </div>
                    <div class="flex justify-end gap-2">
                        ${turmaId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="turmas" data-id="${turmaId}">Excluir</button>` : ''}
                        <button type="submit" class="primary-btn w-auto">Salvar Turma</button>
                    </div>
                </form>
            `;
            const levelSelect = document.getElementById('turma-level');
            const levelCustomInput = document.getElementById('turma-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });
            document.getElementById('form-modal-body').onsubmit = saveTurma;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveTurma(event) {
            event.preventDefault();
            const turmaId = document.getElementById('turma-id').value;
            const teacherSelect = document.getElementById('turma-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];

            const levelSelect = document.getElementById('turma-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('turma-level-custom').value
                : levelSelect.value;

            const data = {
                name: document.getElementById('turma-name').value,
                teacherId: selectedTeacherOption.value,
                teacherName: selectedTeacherOption.getAttribute('data-name'),
                level: levelValue,
                studentIds: Array.from(document.querySelectorAll('input[name="turma-students"]:checked')).map(cb => cb.value),
                semestre: document.getElementById('turma-semestre').value,
                startDate: document.getElementById('turma-startDate').value,
                endDate: document.getElementById('turma-endDate').value,
            };

            if (!data.name || !data.teacherId) {
                showErrorMessage("Erro", "Nome da turma e professor são obrigatórios.");
                return;
            }

            try {
                if (turmaId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/turmas`, turmaId), data);
                    showSuccessMessage("Sucesso", "Turma atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/turmas`), data);
                    showSuccessMessage("Sucesso", "Nova turma criada.");
                }
            } catch (error) {
                console.error("Error saving turma:", error);
                showErrorMessage("Erro", "Não foi possível salvar a turma.");
            }
        }

        function openVipForm(vipId = null) {
            clearModalHeaderButtons();
            const vip = vipId ? vips.find(v => v.id === vipId) : null;
            document.getElementById('form-modal-title').textContent = vip ? "Editar VIP" : "Adicionar Novo VIP";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${vip?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = cps.map(cp => `<option value="${cp.title}" ${vip?.level === cp.title ? 'selected' : ''}>${cp.title}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;
            const studentOptions = students.filter(s => s.status === 'Ativo').map(s => `<option value="${s.id}" data-name="${s.name}" ${vip?.studentId === s.id ? 'selected' : ''}>${s.name}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="vip-id" value="${vipId || ''}">
                    <div><label class="font-medium text-sm">Aluno</label><select id="vip-student" class="form-input" required>${studentOptions}</select></div>
                    <div><label class="font-medium text-sm">Professor</label><select id="vip-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div>
                        <label class="font-medium text-sm">Nível</label>
                        <select id="vip-level" class="form-input" required>${levelOptions}</select>
                        <input type="text" id="vip-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Semestre</label><input type="text" id="vip-semestre" class="form-input" value="${vip?.semestre || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="vip-startDate" class="form-input" value="${vip?.startDate || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Finalização</label><input type="date" id="vip-endDate" class="form-input" value="${vip?.endDate || ''}"></div>
                    </div>
                    <div class="flex justify-end gap-2">
                        ${vipId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="vips" data-id="${vipId}">Excluir</button>` : ''}
                        <button type="submit" class="primary-btn w-auto">Salvar VIP</button>
                    </div>
                </form>
            `;
            const levelSelect = document.getElementById('vip-level');
            const levelCustomInput = document.getElementById('vip-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });
            document.getElementById('form-modal-body').onsubmit = saveVip;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveVip(event) {
            event.preventDefault();
            const vipId = document.getElementById('vip-id').value;
            const teacherSelect = document.getElementById('vip-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];
            const studentSelect = document.getElementById('vip-student');
            const selectedStudentOption = studentSelect.options[studentSelect.selectedIndex];

            const levelSelect = document.getElementById('vip-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('vip-level-custom').value
                : levelSelect.value;

            const data = {
                studentId: selectedStudentOption.value,
                studentName: selectedStudentOption.getAttribute('data-name'),
                teacherId: selectedTeacherOption.value,
                teacherName: selectedTeacherOption.getAttribute('data-name'),
                level: levelValue,
                semestre: document.getElementById('vip-semestre').value,
                startDate: document.getElementById('vip-startDate').value,
                endDate: document.getElementById('vip-endDate').value,
            };

            if (!data.studentId || !data.teacherId) {
                showErrorMessage("Erro", "Aluno e professor são obrigatórios.");
                return;
            }

            try {
                if (vipId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/vips`, vipId), data);
                    showSuccessMessage("Sucesso", "VIP atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/vips`), data);
                    showSuccessMessage("Sucesso", "Novo VIP criado.");
                }
            } catch (error) {
                console.error("Error saving VIP:", error);
                showErrorMessage("Erro", "Não foi possível salvar o VIP.");
            }
        }

        function openTurmaPefModal(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma não encontrada."); return; }

            const modal = document.getElementById('form-modal');
            modal.dataset.pefModal = "true";
            modal.dataset.unitId = turmaId;
            modal.dataset.pefType = "turma";
            
            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');

            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar PEF';
            exportButton.dataset.action = 'export-turma-pef';
            exportButton.dataset.id = turmaId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));
            
            modalTitle.textContent = `PEF: ${turma.name}`;

            const turmaStudents = (turma.studentIds || []).map(id => students.find(s => s.id === id)).filter(Boolean);
            const unitAttendance = attendance.find(a => a.id === turmaId);

            let lessonsHtml = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i];
                const lessonDate = lessonData?.date || '';
                
                const studentsHtml = turmaStudents.map(student => {
                    const studentStatus = lessonData?.students?.[student.id] || '';
                    return `
                        <div class="pef-student-attendance-row" data-student-id="${student.id}">
                            <span class="text-sm">${student.name}</span>
                            <div class="pef-status-btn-group flex gap-1">
                                <button data-action="mark-attendance" data-status="P" class="${studentStatus === 'P' ? 'active P' : ''}">P</button>
                                <button data-action="mark-attendance" data-status="F" class="${studentStatus === 'F' ? 'active F' : ''}">F</button>
                                <button data-action="mark-attendance" data-status="PP" class="${studentStatus === 'PP' ? 'active PP' : ''}">PP</button>
                            </div>
                        </div>
                    `;
                }).join('');

                lessonsHtml += `
                    <div class="pef-lesson-row" id="lesson-row-${turmaId}-${i}">
                        <div class="flex flex-col justify-center items-center gap-2">
                             <span class="font-bold text-stone-700">Aula ${i}</span>
                             <button class="secondary-btn !text-xs !py-1 !px-3" data-action="save-pef-lesson" data-unit-id="${turmaId}" data-lesson-number="${i}">Salvar</button>
                        </div>
                        <input type="date" class="form-input p-2 text-sm lesson-date self-center" value="${lessonDate}">
                        <div class="space-y-2">
                            <textarea class="form-input p-2 text-sm w-full lesson-topic" placeholder="Tema da aula">${lessonData?.topic || ''}</textarea>
                            <textarea class="form-input p-2 text-sm w-full lesson-notes mt-2" placeholder="Observações da aula">${lessonData?.notes || ''}</textarea>
                            ${studentsHtml}
                        </div>
                    </div>
                `;
            }
            
            modalContentArea.innerHTML = `<div>${lessonsHtml}</div>`;
            modal.classList.add('visible');
        }

        function openVipPefModal(vipId) {
            const vip = vips.find(v => v.id === vipId);
            if (!vip) { showErrorMessage("Erro", "Aluno VIP não encontrado."); return; }
            const student = students.find(s => s.id === vip.studentId);
            if (!student) { showErrorMessage("Erro", "Dados do aluno não encontrados."); return; }

            const modal = document.getElementById('form-modal');
            modal.dataset.pefModal = "true";
            modal.dataset.unitId = vipId;
            modal.dataset.pefType = "vip";

            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');
            
            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar PEF';
            exportButton.dataset.action = 'export-vip-pef';
            exportButton.dataset.id = vipId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));
            
            modalTitle.textContent = `PEF (VIP): ${vip.studentName}`;

            const unitAttendance = attendance.find(a => a.id === vipId);

            let lessonsHtml = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i];
                const lessonDate = lessonData?.date || '';
                const lessonNotes = lessonData?.notes || '';
                const lessonTopic = lessonData?.topic || '';
                const studentStatus = lessonData?.students?.[student.id] || '';

                const studentHtml = `
                    <div class="pef-student-attendance-row" data-student-id="${student.id}">
                        <span class="text-sm font-semibold">${student.name}</span>
                        <div class="pef-status-btn-group flex gap-1">
                            <button data-action="mark-attendance" data-status="P" class="${studentStatus === 'P' ? 'active P' : ''}">P</button>
                            <button data-action="mark-attendance" data-status="F" class="${studentStatus === 'F' ? 'active F' : ''}">F</button>
                            <button data-action="mark-attendance" data-status="PP" class="${studentStatus === 'PP' ? 'active PP' : ''}">PP</button>
                        </div>
                    </div>
                `;

                lessonsHtml += `
                    <div class="pef-lesson-row" id="lesson-row-${vipId}-${i}">
                        <div class="flex flex-col justify-center items-center gap-2">
                             <span class="font-bold text-stone-700">Aula ${i}</span>
                             <button class="secondary-btn !text-xs !py-1 !px-3" data-action="save-pef-lesson" data-unit-id="${vipId}" data-lesson-number="${i}">Salvar</button>
                        </div>
                        <input type="date" class="form-input p-2 text-sm lesson-date self-center" value="${lessonDate}">
                        <div class="space-y-2">
                            <textarea class="form-input p-2 text-sm w-full lesson-topic" placeholder="Tema da aula">${lessonTopic}</textarea>
                            <textarea class="form-input p-2 text-sm w-full lesson-notes mt-2" placeholder="Observações da aula">${lessonNotes}</textarea>
                            ${studentHtml}
                        </div>
                    </div>
                `;
            }
            
            modalContentArea.innerHTML = `<div>${lessonsHtml}</div>`;
            modal.classList.add('visible');
        }

        async function savePefLesson(unitId, lessonNumber) {
            const lessonRow = document.getElementById(`lesson-row-${unitId}-${lessonNumber}`);
            if (!lessonRow) {
                console.error("Lesson row not found");
                return;
            }

            const date = lessonRow.querySelector('.lesson-date').value;
            const topic = lessonRow.querySelector('.lesson-topic').value;
            const notes = lessonRow.querySelector('.lesson-notes').value;

            const studentAttendance = {};
            const studentRows = lessonRow.querySelectorAll('.pef-student-attendance-row');
            studentRows.forEach(row => {
                const studentId = row.dataset.studentId;
                const activeButton = row.querySelector('.pef-status-btn-group button.active');
                const status = activeButton ? activeButton.dataset.status : '';
                if (studentId) {
                    studentAttendance[studentId] = status;
                }
            });

            if (!date) {
                showErrorMessage("Data Obrigatória", "Por favor, selecione a data da aula antes de salvar.");
                return;
            }

            const attendanceRef = doc(db, `artifacts/${appId}/public/data/attendance`, unitId);
            
            const lessonData = {
                date: date,
                students: studentAttendance,
                topic: topic,
                notes: notes,
            };

            try {
                await setDoc(attendanceRef, {
                    id: unitId,
                    lessons: {
                        [lessonNumber]: lessonData
                    }
                }, { merge: true });
                
                showSuccessMessage("Sucesso!", `Presença da Aula ${lessonNumber} foi salva.`);
            } catch (error) {
                console.error("Error saving attendance: ", error);
                showErrorMessage("Erro", "Falha ao salvar a presença. Tente novamente.");
            }
        }

        function openEventForm(eventId = null) {
            clearModalHeaderButtons();
            const event = eventId ? events.find(e => e.id === eventId) : null;
            document.getElementById('form-modal-title').textContent = event ? "Editar Evento" : "Adicionar Novo Evento";
            const sectorOptions = ["Financeiro", "Pedagógico", "Comercial", "Marketing"].map(s => `<option value="${s}" ${event?.setor === s ? 'selected' : ''}>${s}</option>`).join('');
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="event-id" value="${eventId || ''}">
                    <div><label class="font-medium text-sm">Nome do Evento</label><input type="text" id="event-name" class="form-input" required value="${event?.nome || ''}"></div>
                    <div><label class="font-medium text-sm">Setor</label><select id="event-sector" class="form-input" required>${sectorOptions}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Data</label><input type="date" id="event-date" class="form-input" required value="${event?.data || ''}"></div>
                        <div><label class="font-medium text-sm">Horário</label><input type="time" id="event-time" class="form-input" value="${event?.time || ''}"></div>
                    </div>
                    <div><label class="font-medium text-sm">Local</label><input type="text" id="event-location" class="form-input" required value="${event?.local || ''}"></div>
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="event-description" rows="4" class="form-input">${event?.descricao || ''}</textarea></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveEvent;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveEvent(event) {
            event.preventDefault();
            const eventId = document.getElementById('event-id').value;
            const data = {
                nome: document.getElementById('event-name').value,
                setor: document.getElementById('event-sector').value,
                data: document.getElementById('event-date').value,
                time: document.getElementById('event-time').value,
                local: document.getElementById('event-location').value,
                descricao: document.getElementById('event-description').value,
            };
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (eventId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/events`, eventId), data);
                    showSuccessMessage("Sucesso!", "Evento atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/events`), data);
                    showSuccessMessage("Sucesso!", "Novo evento adicionado.");
                }
            } catch (error) { console.error("Error saving event:", error); showErrorMessage("Erro", "Falha ao salvar o evento."); }
        }

        function openEventModal(eventId) {
            clearModalHeaderButtons();
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            document.getElementById('form-modal-title').textContent = event.nome;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Data:</strong> ${new Date(event.data + 'T00:00:00').toLocaleDateString('pt-BR')} ${event.time ? `às ${event.time}`: ''}</p>
                    <p><strong>Local:</strong> ${event.local}</p>
                    ${event.setor ? `<p><strong>Setor:</strong> <span class="status-tag status-${event.setor.toLowerCase()}">${event.setor}</span></p>` : ''}
                    ${event.descricao ? `<div><strong>Descrição:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md whitespace-pre-wrap">${event.descricao}</p></div>` : ''}
                    <div class="border-t pt-4 flex justify-end gap-2">
                        <button class="secondary-btn" data-action="edit-event" data-id="${event.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="events" data-id="${event.id}">Apagar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openBudgetForm(budgetId = null) {
            clearModalHeaderButtons();
            const budget = budgetId ? budgets.find(b => b.id === budgetId) : null;
            const collaboratorOptions = collaborators.filter(c => c.sectors && c.sectors.includes('orcamentos')).map(c => `<option value="${c.name}" ${budget?.criadoPor === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            document.getElementById('form-modal-title').textContent = budget ? "Editar Orçamento" : "Adicionar Novo Orçamento";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="budget-id" value="${budgetId || ''}">
                    <div><label class="font-medium text-sm">Título</label><input type="text" id="budget-title" class="form-input" required value="${budget?.titulo || ''}"></div>
                    <div><label class="font-medium text-sm">Fornecedor</label><input type="text" id="budget-provider" class="form-input" required value="${budget?.fornecedor || ''}"></div>
                    <div><label class="font-medium text-sm">Data do Orçamento</label><input type="date" id="budget-date" class="form-input" required value="${budget?.dataCriacao || ''}"></div>
                    <div><label class="font-medium text-sm">Criado por</label><select id="budget-owner" class="form-input" required>${collaboratorOptions}</select></div>
                    <div><label class="font-medium text-sm">Valor (R$)</label><input type="number" step="0.01" id="budget-value" class="form-input" required value="${budget?.valor || ''}"></div>
                    <div><label class="font-medium text-sm">Status</label><select id="budget-status" class="form-input" required><option>Pendente</option><option>Aprovado</option><option>Rejeitado</option></select></div>
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="budget-description" rows="3" class="form-input">${budget?.descricao || ''}</textarea></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            if (budget) document.getElementById('budget-status').value = budget.status;
            document.getElementById('form-modal-body').onsubmit = saveBudget;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveBudget(event) {
            event.preventDefault();
            const budgetId = document.getElementById('budget-id').value;
            const data = {
                titulo: document.getElementById('budget-title').value,
                fornecedor: document.getElementById('budget-provider').value,
                dataCriacao: document.getElementById('budget-date').value,
                criadoPor: document.getElementById('budget-owner').value,
                valor: document.getElementById('budget-value').value,
                status: document.getElementById('budget-status').value,
                descricao: document.getElementById('budget-description').value,
            };
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (budgetId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/budgets`, budgetId), data);
                    showSuccessMessage("Sucesso!", "Orçamento atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/budgets`), data);
                    showSuccessMessage("Sucesso!", "Novo orçamento adicionado.");
                }
            } catch (error) { console.error("Error saving budget:", error); showErrorMessage("Erro", "Falha ao salvar o orçamento."); }
        }

        function openBudgetModal(budgetId) {
            clearModalHeaderButtons();
            const budget = budgets.find(b => b.id === budgetId);
            if (!budget) return;
            document.getElementById('form-modal-title').textContent = budget.titulo;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Fornecedor:</strong> ${budget.fornecedor}</p>
                    <p><strong>Data:</strong> ${budget.dataCriacao ? new Date(budget.dataCriacao + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                    <p><strong>Criado por:</strong> ${budget.criadoPor || 'N/A'}</p>
                    <p><strong>Valor:</strong> R$ ${parseFloat(budget.valor || 0).toFixed(2)}</p>
                    <p><strong>Status:</strong> <span class="status-tag status-${budget.status.toLowerCase()}">${budget.status}</span></p>
                    ${budget.descricao ? `<div><strong>Descrição:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${budget.descricao}</p></div>` : ''}
                    <div class="border-t pt-4 flex justify-end gap-2">
                        <button class="secondary-btn" data-action="edit-budget" data-id="${budget.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="budgets" data-id="${budget.id}">Apagar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openTaskForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = "Adicionar Nova Tarefa";
            const collaboratorOptions = collaborators.filter(c => c.sectors && (c.sectors.includes('tarefas') || c.sectors.includes('professor'))).map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="task-description" rows="4" class="form-input" required></textarea></div>
                    <div><label class="font-medium text-sm">Prazo Final</label><input type="date" id="task-deadline" class="form-input" required></div>
                    <div><label class="font-medium text-sm">Atribuir para (selecione um ou mais)</label><select id="task-assignedTo" class="form-input" multiple required>${collaboratorOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Tarefa</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveTask;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveTask(event) {
            event.preventDefault();
            const data = {
                description: document.getElementById('task-description').value,
                deadline: document.getElementById('task-deadline').value,
                assignedTo: Array.from(document.getElementById('task-assignedTo').selectedOptions).map(o => o.value),
                assignedBy: currentUserName || 'Admin',
                createdAt: serverTimestamp(),
                completed: false
            };
            if (!data.description || !data.deadline || data.assignedTo.length === 0) { showErrorMessage("Erro de Validação", "Por favor, preencha todos os campos obrigatórios."); return; }
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), data);
                showSuccessMessage("Sucesso!", "Tarefa adicionada.");
            } catch (error) { console.error("Error saving task:", error); showErrorMessage("Erro", "Falha ao salvar a tarefa."); }
        }
        
        function openCollaboratorForm(collaboratorId = null) {
            clearModalHeaderButtons();
            const collaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;
            document.getElementById('form-modal-title').textContent = collaborator ? "Editar Colaborador" : "Adicionar Novo Colaborador";
            
            const sectors = ['professor', 'tarefas', 'cancelamentos', 'orcamentos', 'banco de fotos'];
            const sectorLabels = { professor: 'Professor (Grade)', tarefas: 'Tarefas', cancelamentos: 'Cancelamentos', orcamentos: 'Orçamentos', 'banco de fotos': 'Banco de Fotos' };
            
            const sectorCheckboxes = sectors.map(sector => {
                const isChecked = collaborator?.sectors?.includes(sector) ? 'checked' : '';
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="sector-${sector.replace(' ', '-')}" name="sectors" value="${sector}" class="h-4 w-4 rounded" ${isChecked}>
                        <label for="sector-${sector.replace(' ', '-')}" class="ml-2 text-sm">${sectorLabels[sector]}</label>
                    </div>
                `;
            }).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="collaborator-id" value="${collaboratorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Colaborador</label><input type="text" id="collaborator-name" class="form-input" required value="${collaborator?.name || ''}"></div>
                    <div>
                        <label class="font-medium text-sm">Setores de Atuação</label>
                        <div class="mt-2 grid grid-cols-2 gap-2">${sectorCheckboxes}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="font-medium text-sm">Início do Turno</label><input type="time" id="collaborator-shift-start" class="form-input" value="${collaborator?.shiftStart || ''}"></div>
                         <div><label class="font-medium text-sm">Fim do Turno</label><input type="time" id="collaborator-shift-end" class="form-input" value="${collaborator?.shiftEnd || ''}"></div>
                    </div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveCollaborator;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveCollaborator(event) {
            event.preventDefault();
            const collaboratorId = document.getElementById('collaborator-id').value;
            const selectedSectors = Array.from(document.querySelectorAll('input[name="sectors"]:checked')).map(cb => cb.value);
            
            const data = {
                name: document.getElementById('collaborator-name').value,
                shiftStart: document.getElementById('collaborator-shift-start').value,
                shiftEnd: document.getElementById('collaborator-shift-end').value,
                sectors: selectedSectors
            };

            if (!data.name) { showErrorMessage("Erro", "O nome do colaborador é obrigatório."); return; }
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            
            const oldCollaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;
            const hadFolderSector = oldCollaborator?.sectors?.includes('banco de fotos');
            const hasFolderSector = data.sectors.includes('banco de fotos');

            try {
                 if (collaboratorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/collaborators`, collaboratorId), data);
                    showSuccessMessage("Sucesso!", "Colaborador atualizado.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/collaborators`), data);
                    showSuccessMessage("Sucesso!", "Colaborador adicionado.");
                }
                
                if(hasFolderSector && !hadFolderSector) {
                    const folderExists = photoFolders.some(f => f.name === data.name);
                    if (!folderExists) {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/photo_folders`), { name: data.name, createdAt: serverTimestamp() });
                    }
                }

            } catch (error) { console.error("Error saving collaborator:", error); showErrorMessage("Erro", "Falha ao salvar o colaborador."); }
        }

        function openScheduleForm(scheduleId = null) {
            clearModalHeaderButtons();
            const schedule = scheduleId ? schedules.find(s => s.id === scheduleId) : null;
            document.getElementById('form-modal-title').textContent = schedule ? "Detalhes da Aula" : "Adicionar Nova Aula";
            const isTeacher = currentUserRole === 'teacher';

            const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}" ${schedule?.teacher === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const dayOptions = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Seg/Qua", "Ter/Qui"].map(d => `<option value="${d}" ${schedule?.day === d ? 'selected' : ''}>${d}</option>`).join('');
            const typeOptions = ["vip", "turma"].map(t => `<option value="${t}" ${schedule?.type === t ? 'selected' : ''}>${t.toUpperCase()}</option>`).join('');
            const levelOptions = cps.map(cp => `<option value="${cp.title}" ${schedule?.level === cp.title ? 'selected' : ''}>${cp.title}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;
            
            let formHtml = `<form id="form-modal-body" class="space-y-4">
                <input type="hidden" id="schedule-id" value="${scheduleId || ''}">
                <div><label class="font-medium text-sm">Aluno/Turma</label><input type="text" id="schedule-student" class="form-input" required value="${schedule?.student || ''}" ${isTeacher ? 'disabled' : ''}></div>
                <div>
                    <label class="font-medium text-sm">Nível</label>
                    <select id="schedule-level" class="form-input" required ${isTeacher ? 'disabled' : ''}>${levelOptions}</select>
                    <input type="text" id="schedule-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado" ${isTeacher ? 'disabled' : ''}>
                </div>
                <div><label class="font-medium text-sm">Professor</label><select id="schedule-teacher" class="form-input" required ${isTeacher ? 'disabled' : ''}>${teacherOptions}</select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-medium text-sm">Dia</label><select id="schedule-day" class="form-input" required ${isTeacher ? 'disabled' : ''}>${dayOptions}</select></div>
                    <div><label class="font-medium text-sm">Tipo</label><select id="schedule-type" class="form-input" required ${isTeacher ? 'disabled' : ''}>${typeOptions}</select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-medium text-sm">Início</label><input type="time" id="schedule-start" class="form-input" required value="${schedule?.startTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                    <div><label class="font-medium text-sm">Fim</label><input type="time" id="schedule-end" class="form-input" required value="${schedule?.endTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                </div>
                ${!isTeacher ? `<div class="pt-4 flex justify-end gap-2">${scheduleId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="schedules" data-id="${scheduleId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>` : ''}
            </form>`;
            document.getElementById('form-modal-content-area').innerHTML = formHtml;

            const levelSelect = document.getElementById('schedule-level');
            const levelCustomInput = document.getElementById('schedule-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });

            document.getElementById('form-modal-body').onsubmit = saveScheduleEntry;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveScheduleEntry(event) {
            event.preventDefault();
            const teacherName = document.getElementById('schedule-teacher').value;
            const startTime = document.getElementById('schedule-start').value;
            
            const teacher = collaborators.find(c => c.name === teacherName);
            if (teacher && teacher.shiftStart && teacher.shiftEnd) {
                if (startTime < teacher.shiftStart || startTime > teacher.shiftEnd) {
                    showConfirmationModal(
                        "Aviso de Horário", 
                        `Este horário (${startTime}) está fora do turno do professor (${teacher.shiftStart} - ${teacher.shiftEnd}). Tem certeza que quer continuar?`,
                        () => proceedWithSaveSchedule()
                    );
                    return;
                }
            }
            proceedWithSaveSchedule();
        }

        async function proceedWithSaveSchedule() {
            const scheduleId = document.getElementById('schedule-id').value;
            const daySelection = document.getElementById('schedule-day').value;
            const daysToCreate = [];
            if (daySelection === 'Seg/Qua') daysToCreate.push('Segunda', 'Quarta');
            else if (daySelection === 'Ter/Qui') daysToCreate.push('Terça', 'Quinta');
            else daysToCreate.push(daySelection);

            const levelSelect = document.getElementById('schedule-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('schedule-level-custom').value
                : levelSelect.value;

            const baseData = { 
                student: document.getElementById('schedule-student').value, 
                level: levelValue, 
                teacher: document.getElementById('schedule-teacher').value, 
                type: document.getElementById('schedule-type').value, 
                startTime: document.getElementById('schedule-start').value, 
                endTime: document.getElementById('schedule-end').value 
            };
            
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (scheduleId) { 
                    const data = {...baseData, day: daySelection };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/schedules`, scheduleId), data); 
                    showSuccessMessage("Sucesso!", "Aula atualizada.");
                } else { 
                    for (const day of daysToCreate) {
                        const data = {...baseData, day: day, createdAt: serverTimestamp() };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), data); 
                    }
                    showSuccessMessage("Sucesso!", "Aula(s) adicionada(s).");
                }
            } catch (error) { console.error("Error saving schedule:", error); showErrorMessage("Erro", "Falha ao salvar a aula."); }
        }

        function openExpenseForm(expenseId = null) {
            clearModalHeaderButtons();
            const expense = expenseId ? expenses.find(e => e.id === expenseId) : null;
            document.getElementById('form-modal-title').textContent = expense ? "Editar Despesa" : "Adicionar Nova Despesa";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="expense-id" value="${expenseId || ''}">
                    <div><label class="font-medium text-sm">Descrição</label><input type="text" id="expense-description" class="form-input" required value="${expense?.description || ''}"></div>
                    
                    <div id="due-date-container" class="${expense?.isFixedSalary ? 'hidden' : ''}">
                        <label class="font-medium text-sm">Vencimento</label>
                        <input type="date" id="expense-dueDate" class="form-input" value="${expense?.dueDate || ''}">
                    </div>
                    
                    <div id="due-day-container" class="${expense?.isFixedSalary ? '' : 'hidden'}">
                        <label class="font-medium text-sm">Dia do Vencimento</label>
                        <input type="number" min="1" max="31" id="expense-dueDay" class="form-input" value="${expense?.dueDay || ''}">
                    </div>

                    <div><label class="font-medium text-sm">Valor (R$)</label><input type="number" step="0.01" id="expense-amount" class="form-input" required value="${expense?.amount || ''}"></div>
                    
                    <div class="flex items-center gap-2"><input type="checkbox" id="expense-isFixedSalary" class="h-4 w-4 rounded" ${expense?.isFixedSalary ? 'checked' : ''}><label for="expense-isFixedSalary" class="text-sm">É salário fixo?</label></div>
                    <div id="employee-role-container" class="${expense?.isFixedSalary ? '' : 'hidden'}"><label class="font-medium text-sm">Cargo</label><input type="text" id="expense-employeeRole" class="form-input" value="${expense?.employeeRole || ''}"></div>
                    <div class="pt-4 flex justify-end gap-2">${expenseId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="expenses" data-id="${expenseId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            
            const isFixedSalaryCheckbox = document.getElementById('expense-isFixedSalary');
            isFixedSalaryCheckbox.onchange = () => {
                const isChecked = isFixedSalaryCheckbox.checked;
                document.getElementById('employee-role-container').classList.toggle('hidden', !isChecked);
                document.getElementById('due-date-container').classList.toggle('hidden', isChecked);
                document.getElementById('due-day-container').classList.toggle('hidden', !isChecked);
            };
            
            document.getElementById('form-modal-body').onsubmit = saveExpense;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveExpense(event) {
            event.preventDefault();
            const expenseId = document.getElementById('expense-id').value;
            const isFixedSalary = document.getElementById('expense-isFixedSalary').checked;
            const data = {
                description: document.getElementById('expense-description').value,
                amount: document.getElementById('expense-amount').value,
                isPaid: false,
                isFixedSalary: isFixedSalary,
                employeeRole: isFixedSalary ? document.getElementById('expense-employeeRole').value : '',
            };

            if (isFixedSalary) {
                data.dueDay = document.getElementById('expense-dueDay').value;
                data.dueDate = null;
            } else {
                data.dueDate = document.getElementById('expense-dueDate').value;
                data.dueDay = null;
            }

            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (expenseId) {
                    const existingExpense = expenses.find(e => e.id === expenseId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/expenses`, expenseId), {...existingExpense, ...data});
                    showSuccessMessage("Sucesso!", "Despesa atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/expenses`), data);
                    showSuccessMessage("Sucesso!", "Nova despesa adicionada.");
                }
            } catch (error) { console.error("Error saving expense:", error); showErrorMessage("Erro", "Falha ao salvar despesa."); }
        }
        async function toggleExpensePaid(expenseId, isPaid) { if (!db) return; const expenseRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId); try { await updateDoc(expenseRef, { isPaid: isPaid }); } catch (error) { console.error("Error updating expense status:", error); } }

        function openCancelamentoForm(cancelamentoId = null) {
            clearModalHeaderButtons();
            const cancelamento = cancelamentoId ? cancellations.find(c => c.id === cancelamentoId) : null;
            const collaboratorOptions = collaborators.filter(c => c.sectors && c.sectors.includes('cancelamentos')).map(c => `<option value="${c.name}" ${cancelamento?.processedBy === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            
            let studentFieldHtml = '';
            if (cancelamentoId) {
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno</label><p class="form-input bg-stone-100">${cancelamento.studentName}</p></div>`;
            } else {
                const activeStudents = students.filter(s => s.status === 'Ativo');
                const studentOptions = activeStudents.map(s => `<option value="${s.id}" data-name="${s.name}">${s.name}</option>`).join('');
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno a Cancelar</label><select id="cancelamento-studentId" class="form-input" required><option value="">Selecione um aluno...</option>${studentOptions}</select></div>`;
            }

            document.getElementById('form-modal-title').textContent = cancelamento ? "Editar Cancelamento" : "Registrar Novo Cancelamento";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="cancelamento-id" value="${cancelamentoId || ''}">
                    ${studentFieldHtml}
                    <div><label class="font-medium text-sm">Data do Cancelamento</label><input type="date" id="cancelamento-date" class="form-input" required value="${cancelamento?.cancellationDate || ''}"></div>
                    <div><label class="font-medium text-sm">Motivo</label><textarea id="cancelamento-reason" rows="3" class="form-input" required>${cancelamento?.reason || ''}</textarea></div>
                    <div><label class="font-medium text-sm">Processado por</label><select id="cancelamento-processedBy" class="form-input" required>${collaboratorOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveCancelamento;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveCancelamento(event) {
            event.preventDefault();
            const cancelamentoId = document.getElementById('cancelamento-id').value;
            if (!db) { console.warn("Offline mode."); return; }

            try {
                if (cancelamentoId) {
                    // Logic to update an existing cancellation record
                    const data = {
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                    };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/cancellations`, cancelamentoId), data);
                    showSuccessMessage("Sucesso!", "Registro de cancelamento atualizado.");
                } else {
                    // Logic to create a new cancellation and update student status
                    const studentSelect = document.getElementById('cancelamento-studentId');
                    if (!studentSelect.value) {
                        showErrorMessage("Erro", "Por favor, selecione um aluno.");
                        return;
                    }
                    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
                    const studentId = selectedOption.value;
                    const studentName = selectedOption.getAttribute('data-name');

                    const data = {
                        studentId: studentId,
                        studentName: studentName,
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                        createdAt: serverTimestamp()
                    };

                    // 1. Add cancellation record
                    await addDoc(collection(db, `artifacts/${appId}/public/data/cancellations`), data);
                    
                    // 2. Update student status
                    const studentRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
                    await updateDoc(studentRef, { status: 'Cancelado' });

                    showSuccessMessage("Sucesso!", `Cancelamento registrado e status do aluno ${studentName} atualizado.`);
                }
            } catch (error) {
                console.error("Error saving cancellation:", error);
                showErrorMessage("Erro", "Falha ao salvar o cancelamento.");
            }
        }
        function openCancelamentoModal(cancelamentoId) {
            clearModalHeaderButtons();
            const cancelamento = cancellations.find(c => c.id === cancelamentoId);
            if (!cancelamento) return;
            const canEdit = ['admin', 'financeiro'].includes(currentUserRole);
            document.getElementById('form-modal-title').textContent = `Cancelamento de ${cancelamento.studentName}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Aluno:</strong> ${cancelamento.studentName}</p>
                    <p><strong>Data:</strong> ${new Date(cancelamento.cancellationDate + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    <p><strong>Processado por:</strong> ${cancelamento.processedBy}</p>
                    <div><strong>Motivo:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${cancelamento.reason}</p></div>
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEdit ? `<button class="secondary-btn" data-action="edit-cancelamento" data-id="${cancelamento.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="cancellations" data-id="${cancelamento.id}">Apagar</button>` : ''}
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }
        
        function openPhotoFormModal() {
            clearModalHeaderButtons();
            const currentFolder = document.getElementById('banco-de-fotos-section')?.dataset.currentFolder || 'Geral';
            document.getElementById('form-modal-title').textContent = "Adicionar Nova Foto";
            
            const folderOptions = photoFolders.map(f => `<option value="${f.name}" ${f.name === currentFolder ? 'selected' : ''}>${f.name}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Título da Foto</label><input type="text" id="photo-title" class="form-input" required></div>
                    <div><label class="font-medium text-sm">URL da Imagem (Cloudinary)</label><input type="url" id="photo-url" class="form-input" required placeholder="https://res.cloudinary.com/..."></div>
                    <div><label class="font-medium text-sm">Pasta</label><select id="photo-folder" class="form-input" required>${folderOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Foto</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = savePhoto;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function savePhoto(event) {
            event.preventDefault();
            const data = {
                title: document.getElementById('photo-title').value,
                url: document.getElementById('photo-url').value,
                folder: document.getElementById('photo-folder').value,
                uploadedBy: currentUserName,
                createdAt: serverTimestamp()
            };

            if (!data.title || !data.url || !data.folder) {
                showErrorMessage("Erro", "Todos os campos são obrigatórios.");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/photo_bank`), data);
                showSuccessMessage("Sucesso!", "Foto adicionada ao banco.");
            } catch (error) {
                console.error("Error saving photo:", error);
                showErrorMessage("Erro", "Não foi possível salvar a foto.");
            }
        }
        
        function openFolderFormModal() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = "Adicionar Nova Pasta";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Nome da Pasta</label><input type="text" id="folder-name" class="form-input" required></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Pasta</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveFolder;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveFolder(event) {
            event.preventDefault();
            const name = document.getElementById('folder-name').value;
            if (!name) { showErrorMessage("Erro", "O nome da pasta é obrigatório."); return; }
            const folderExists = photoFolders.some(f => f.name.toLowerCase() === name.toLowerCase());
            if (folderExists) { showErrorMessage("Erro", "Uma pasta com este nome já existe."); return; }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/photo_folders`), { name, createdAt: serverTimestamp() });
                showSuccessMessage("Sucesso!", "Pasta criada.");
            } catch (error) {
                console.error("Error saving folder:", error);
                showErrorMessage("Erro", "Não foi possível criar a pasta.");
            }
        }

        async function deleteFolder(folderId, folderName) {
            if (!db) return;
            showConfirmationModal(
                "Excluir Pasta?",
                `Tem certeza que deseja excluir a pasta "${folderName}"? TODAS as fotos dentro dela serão apagadas permanentemente.`,
                async () => {
                    try {
                        // Batch delete photos in the folder
                        const photosQuery = query(collection(db, `artifacts/${appId}/public/data/photo_bank`), where("folder", "==", folderName));
                        const photosSnapshot = await getDocs(photosQuery);
                        const batch = writeBatch(db);
                        photosSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();

                        // Delete the folder document itself
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/photo_folders`, folderId));
                        
                        showSuccessMessage("Sucesso", `Pasta "${folderName}" e todas as suas fotos foram excluídas.`);
                    } catch (error) {
                        console.error("Error deleting folder and its contents:", error);
                        showErrorMessage("Erro", "Falha ao excluir a pasta.");
                    }
                }
            );
        }

        function openNivelForm(nivelId = null) {
            clearModalHeaderButtons();
            const nivel = nivelId ? cps.find(n => n.id === nivelId) : null;
            document.getElementById('form-modal-title').textContent = nivel ? 'Editar Nível' : 'Adicionar Novo Nível';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="nivel-id" value="${nivelId || ''}">
                    <div><label class="font-medium text-sm">Título do Nível</label><input type="text" id="nivel-title" class="form-input" required value="${nivel?.title || ''}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveNivel;
            document.getElementById('form-modal').classList.add('visible');
        }
        
        async function saveNivel(event) {
            event.preventDefault();
            const nivelId = document.getElementById('nivel-id').value;
            const title = document.getElementById('nivel-title').value;
            if (!title) { showErrorMessage("Erro", "O título é obrigatório."); return; }
            
            try {
                if (nivelId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/cps`, nivelId), { title });
                    showSuccessMessage("Sucesso", "Nível atualizado.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/cps`), { title, lessons: [], order: cps.length });
                    showSuccessMessage("Sucesso", "Nível adicionado.");
                }
            } catch(e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar o nível."); }
        }
        
        function openAulaForm(nivelId, aulaIndex = null) {
            clearModalHeaderButtons();
            const nivel = cps.find(n => n.id === nivelId);
            const aula = (aulaIndex !== null && nivel && nivel.lessons) ? nivel.lessons[aulaIndex] : null;
            document.getElementById('form-modal-title').textContent = aula ? 'Editar Aula' : 'Adicionar Nova Aula';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="aula-nivel-id" value="${nivelId}">
                    <input type="hidden" id="aula-index" value="${aulaIndex !== null ? aulaIndex : ''}">
                    <div><label class="font-medium text-sm">Título da Aula</label><input type="text" id="aula-title" class="form-input" required value="${aula?.title || ''}"></div>
                    <div><label class="font-medium text-sm">Tema/Descrição</label><textarea id="aula-topic" class="form-input" rows="3" required>${aula?.topic || ''}</textarea></div>
                    <div><label class="font-medium text-sm">Palavras-chave (separadas por vírgula)</label><input type="text" id="aula-keywords" class="form-input" value="${(aula?.keywords || []).join(', ')}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveAula;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveAula(event) {
            event.preventDefault();
            const nivelId = document.getElementById('aula-nivel-id').value;
            const aulaIndex = document.getElementById('aula-index').value;
            const nivelRef = doc(db, `artifacts/${appId}/public/data/cps`, nivelId);
            
            const keywordsString = document.getElementById('aula-keywords').value;
            const keywords = keywordsString.split(',').map(k => k.trim()).filter(Boolean);

            const novaAula = {
                title: document.getElementById('aula-title').value,
                topic: document.getElementById('aula-topic').value,
                keywords: keywords
            };

            try {
                if (aulaIndex) { // Edit existing lesson
                    const nivelDoc = await getDoc(nivelRef);
                    const lessons = nivelDoc.data().lessons;
                    lessons[aulaIndex] = novaAula;
                    await updateDoc(nivelRef, { lessons });
                } else { // Add new lesson
                    await updateDoc(nivelRef, { lessons: arrayUnion(novaAula) });
                }
                showSuccessMessage("Sucesso", "Aula salva.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar a aula."); }
        }

        async function deleteAula(nivelId, aulaIndex) {
            const nivelRef = doc(db, `artifacts/${appId}/public/data/cps`, nivelId);
            const nivel = cps.find(n => n.id === nivelId);
            const aulaParaRemover = nivel.lessons[aulaIndex];
            try {
                await updateDoc(nivelRef, { lessons: arrayRemove(aulaParaRemover) });
                showSuccessMessage("Sucesso", "Aula removida.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível remover a aula."); }
        }
        
        async function reorderCPLevel(levelId, direction) {
            const currentIndex = cps.findIndex(c => c.id === levelId);
            if (currentIndex === -1) return;

            const otherIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (otherIndex < 0 || otherIndex >= cps.length) return;

            const currentLevel = cps[currentIndex];
            const otherLevel = cps[otherIndex];

            const batch = writeBatch(db);
            const currentRef = doc(db, `artifacts/${appId}/public/data/cps`, currentLevel.id);
            const otherRef = doc(db, `artifacts/${appId}/public/data/cps`, otherLevel.id);

            batch.update(currentRef, { order: otherLevel.order });
            batch.update(otherRef, { order: currentLevel.order });

            try {
                await batch.commit();
            } catch (error) {
                console.error("Error reordering levels:", error);
                showErrorMessage("Erro", "Falha ao reordenar os níveis.");
            }
        }
        
        function openDojoCompetitorForm(competitorId = null) {
            clearModalHeaderButtons();
            const competitor = competitorId ? dojoRanking.find(c => c.id === competitorId) : null;
            document.getElementById('form-modal-title').textContent = competitor ? 'Editar Competidor' : 'Adicionar Competidor';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Competidor</label><input type="text" id="dojo-name" class="form-input" required value="${competitor?.name || ''}"></div>
                    <div><label class="font-medium text-sm">URL da Foto</label><input type="url" id="dojo-photo" class="form-input" required value="${competitor?.photo || ''}"></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor?.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoCompetitor;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoCompetitor(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const data = {
                name: document.getElementById('dojo-name').value,
                photo: document.getElementById('dojo-photo').value,
                points: Number(document.getElementById('dojo-points').value)
            };
            if (!data.name || !data.photo) { showErrorMessage("Erro", "Nome e foto são obrigatórios."); return; }
            try {
                if (competitorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), data);
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_ranking`), data);
                }
                showSuccessMessage("Sucesso", "Competidor do Dojo salvo.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar o competidor."); }
        }

        function openDojoPointsForm(competitorId) {
            clearModalHeaderButtons();
            const competitor = dojoRanking.find(c => c.id === competitorId);
            if (!competitor) return;
            document.getElementById('form-modal-title').textContent = `Editar Pontos de ${competitor.name}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId}">
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Pontos</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoPoints;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoPoints(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const points = Number(document.getElementById('dojo-points').value);
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), { points });
                showSuccessMessage("Sucesso", "Pontuação atualizada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível atualizar a pontuação."); }
        }

        function openDojoMissionForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = 'Adicionar Nova Missão';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Descrição da Missão</label><input type="text" id="mission-description" class="form-input" required></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="mission-points" class="form-input" required value="0"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Missão</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoMission;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoMission(event) {
            event.preventDefault();
            const data = {
                description: document.getElementById('mission-description').value,
                points: Number(document.getElementById('mission-points').value)
            };
            if (!data.description) { showErrorMessage("Erro", "A descrição é obrigatória."); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_missions`), data);
                showSuccessMessage("Sucesso", "Nova missão do Dojo adicionada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar a missão."); }
        }


        async function toggleTaskCompletion(taskId, isCompleted) { if (!db) return; const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId); try { await updateDoc(taskRef, { completed: isCompleted }); } catch (error) { console.error("Error updating task status:", error); } }

        async function deleteItem(collectionName, itemId) {
            if (!db) { console.warn("Offline mode."); return; }
            showConfirmationModal(
                "Confirmar Exclusão",
                "Tem certeza que deseja apagar este item? Esta ação não pode ser desfeita.",
                async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, itemId));
                        showSuccessMessage("Sucesso", "Item apagado com sucesso.");
                        closeFormModal();
                    } catch (error) { 
                        console.error(`Error deleting item from ${collectionName}:`, error); 
                        showErrorMessage("Erro", "Falha ao apagar o item.");
                    }
                }
            );
        }
        
        // --- EXPORT FUNCTIONS ---
        function openHtmlInNewWindow(title, htmlContent) {
            const newWindow = window.open();
            newWindow.document.write(htmlContent);
            newWindow.document.title = title;
            newWindow.document.close();
        }
        


        function exportVipPef(vipId) {
            const vip = vips.find(v => v.id === vipId);
            const student = students.find(s => s.id === vip.studentId);
            const unitAttendance = attendance.find(a => a.id === vipId);
            if (!vip || !student) {
                showErrorMessage("Erro", "Não foi possível encontrar os dados para exportação.");
                return;
            }

            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presença Parcial', '': 'Não Registrado' };
            let tableRows = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};
                const studentStatus = lessonData.students?.[student.id] || '';
                tableRows += `
                    <tr>
                        <td>${i}</td>
                        <td>${lessonData.date || ''}</td>
                        <td>${statusMap[studentStatus]}</td>
                        <td>${lessonData.topic || ''}</td>
                        <td>${lessonData.notes || ''}</td>
                    </tr>
                `;
            }

            const docHtml = `
                <html>
                <head>
                    <title>PEF - ${student.name}</title>
                    <style>
                        body { font-family: sans-serif; margin: 2rem; }
                        h1, h2 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .header-info p { margin: 4px 0; }
                    </style>
                </head>
                <body>
                    <h1>Relatório de Presença e Frequência (PEF)</h1>
                    <div class="header-info">
                        <p><strong>Aluno:</strong> ${student.name}</p>
                        <p><strong>Professor:</strong> ${vip.teacherName}</p>
                        <p><strong>Nível:</strong> ${vip.level}</p>
                        <p><strong>Semestre:</strong> ${vip.semestre || 'N/A'}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Aula</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Tema da Aula</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            openHtmlInNewWindow(`PEF - ${student.name}`, docHtml);
        }
        
        function exportTurmaPef(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma não encontrada."); return; }
            
            const turmaStudents = (turma.studentIds || []).map(id => students.find(s => s.id === id)).filter(Boolean);
            const unitAttendance = attendance.find(a => a.id === turmaId);
            if (!turmaStudents.length) { showErrorMessage("Erro", "Nenhum aluno na turma para exportar."); return; }

            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presença Parcial', '': 'Não Registrado' };
            let lessonsHtml = '';

            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};
                const studentStatusesHtml = turmaStudents.map(s => {
                    const status = lessonData?.students?.[s.id] || '';
                    return `<li><strong>${s.name}:</strong> ${statusMap[status]}</li>`;
                }).join('');

                lessonsHtml += `
                    <div class="lesson-block">
                        <h3>Aula ${i} - Data: ${lessonData.date || 'Não definida'}</h3>
                        <p><strong>Tema:</strong> ${lessonData.topic || 'N/A'}</p>
                        <p><strong>Observações:</strong> ${lessonData.notes || 'N/A'}</p>
                        <h4>Presenças:</h4>
                        <ul>${studentStatusesHtml}</ul>
                    </div>
                `;
            }

            const docHtml = `
                <html>
                <head>
                    <title>PEF - Turma ${turma.name}</title>
                    <style>
                        body { font-family: sans-serif; margin: 2rem; }
                        h1, h2, h3, h4 { color: #333; }
                        .header-info p { margin: 4px 0; }
                        .lesson-block { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
                        .lesson-block ul { list-style: none; padding-left: 0; }
                        .lesson-block li { padding: 4px 0; border-bottom: 1px dotted #eee; }
                        .lesson-block li:last-child { border-bottom: none; }
                    </style>
                </head>
                <body>
                    <h1>Relatório de Presença e Frequência (PEF)</h1>
                    <div class="header-info">
                        <h2>Turma: ${turma.name}</h2>
                        <p><strong>Professor:</strong> ${turma.teacherName}</p>
                        <p><strong>Nível:</strong> ${turma.level}</p>
                        <p><strong>Semestre:</strong> ${turma.semestre || 'N/A'}</p>
                    </div>
                    ${lessonsHtml}
                </body>
                </html>
            `;

            openHtmlInNewWindow(`PEF - Turma ${turma.name}`, docHtml);
        }

        function exportCPsDoc() {
            if (cps.length === 0) {
                showErrorMessage("Exportação Falhou", "Não há Cronogramas Pedagógicos para exportar.");
                return;
            }

            let CPsHtml = '';
            cps.forEach(nivel => {
                CPsHtml += `<h2>Nível: ${nivel.title}</h2>`;
                const lessonsHtml = (nivel.lessons && nivel.lessons.length > 0)
                    ? nivel.lessons.map((aula, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${aula.title}</td>
                            <td>${aula.topic}</td>
                            <td>${(aula.keywords || []).join(', ')}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="4">Nenhuma aula cadastrada.</td></tr>';

                CPsHtml += `
                    <table>
                        <thead>
                            <tr>
                                <th style="width:5%;">#</th>
                                <th style="width:25%;">Título da Aula</th>
                                <th>Tema/Descrição</th>
                                <th style="width:20%;">Palavras-chave</th>
                            </tr>
                        </thead>
                        <tbody>${lessonsHtml}</tbody>
                    </table>
                `;
            });

             const docHtml = `
                <html>
                <head>
                    <title>Cronogramas Pedagógicos (CPs) - SLAP</title>
                    <style>
                        body { font-family: sans-serif; margin: 2rem; }
                        h1 { color: #333; border-bottom: 2px solid #F1D24B; padding-bottom: 0.5rem; }
                        h2 { color: #444; margin-top: 2.5rem; border-bottom: 1px solid #ddd; padding-bottom: 0.25rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>Cronogramas Pedagógicos (CPs) - SLAP</h1>
                    ${CPsHtml}
                </body>
                </html>
            `;
            
            openHtmlInNewWindow("Cronogramas Pedagógicos (CPs)", docHtml);
        }

        // --- Calendar Functions ---
        function renderCalendarioSection() {
            document.getElementById('main-title').textContent = 'Calendário de Eventos';
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="flex items-center gap-4">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)">« Anterior</button>
                            <h2 id="calendar-month-year" class="text-2xl font-bold text-stone-800"></h2>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)">Próximo »</button>
                        </div>
                        ${currentUserRole === 'admin' ? `
                        <button class="primary-btn w-auto" data-action="add-calendar-event">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar Evento
                        </button>
                        ` : ''}
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
                
                <!-- Event Modal -->
                <div id="calendar-event-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4 id="event-modal-title">Evento</h4>
                            <button data-action="close-calendar-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="calendar-event-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">Título</label>
                                    <input type="text" id="event-title" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data</label>
                                    <input type="date" id="event-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Horário</label>
                                    <input type="time" id="event-time" class="form-input">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Tipo</label>
                                    <select id="event-type" class="form-input" required>
                                        <option value="evento">Evento Geral</option>
                                        <option value="gravacao">Gravação</option>
                                        <option value="lembrete">Lembrete</option>
                                        <option value="aula-extra">Aula Extra</option>
                                        <option value="data-comemorativa">Data Comemorativa</option>
                                        <option value="reuniao">Reunião</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descrição</label>
                                    <textarea id="event-description" rows="3" class="form-input"></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" data-action="close-calendar-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            initializeCalendar();
        }

        let currentCalendarDate = new Date();
        let calendarEvents = [];

        function initializeCalendar() {
            renderCalendar();
            loadCalendarEvents();
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const monthYear = document.getElementById('calendar-month-year');
            const calendarGrid = document.getElementById('calendar-grid');
            
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            monthYear.textContent = `${months[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let html = days.map(day => `<div class="calendar-day-header">${day}</div>`).join('');
            
            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = currentDay.getMonth() === currentCalendarDate.getMonth();
                const isToday = currentDay.toDateString() === new Date().toDateString();
                const dayEvents = getEventsForDate(currentDay);
                
                html += `
                    <div class="calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}" 
                         data-date="${currentDay.toISOString().split('T')[0]}">
                        <div class="calendar-day-number">${currentDay.getDate()}</div>
                        ${dayEvents.map(event => 
                            `<div class="calendar-event ${event.type}" onclick="viewCalendarEvent('${event.id}')">${event.title}</div>`
                        ).join('')}
                    </div>
                `;
            }
            
            calendarGrid.innerHTML = html;
        }

        function getEventsForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            return calendarEvents.filter(event => event.date === dateString);
        }

        function loadCalendarEvents() {
            // Load from localStorage or initialize with sample data
            const savedEvents = localStorage.getItem('calendar-events');
            if (savedEvents) {
                calendarEvents = JSON.parse(savedEvents);
            } else {
                calendarEvents = [
                    { id: '1', title: 'Reunião Pedagógica', date: '2025-01-15', time: '09:00', type: 'reuniao', description: 'Reunião mensal da equipe pedagógica' },
                    { id: '2', title: 'Gravação Aula', date: '2025-01-20', time: '14:00', type: 'gravacao', description: 'Gravação da aula de pronunciação avançada' }
                ];
                saveCalendarEvents();
            }
            renderCalendar();
        }

        function saveCalendarEvents() {
            localStorage.setItem('calendar-events', JSON.stringify(calendarEvents));
        }

        // --- Pedagogical Challenge Functions ---
        function renderDesafioPedagogicoSection() {
            document.getElementById('main-title').textContent = 'Desafio Pedagógico';
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="bg-[#F1D24B] p-6 rounded-xl shadow-lg mb-8">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex-grow text-center">
                            <h1 class="text-2xl sm:text-3xl font-bold text-stone-800">Pedagogical Challenge</h1>
                            <p class="text-md sm:text-lg text-stone-700 mt-1">A new topic every month to sharpen your skills.</p>
                        </div>
                        <div class="bg-white text-stone-800 px-4 py-2 rounded-lg shadow-inner text-center flex-shrink-0">
                            <span id="challenge-month-display" class="font-bold text-xl">MONTHLY MODULE</span>
                        </div>
                        ${currentUserRole === 'admin' ? `
                        <button class="secondary-btn w-auto" data-action="edit-challenge-content">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Editar Conteúdo
                        </button>
                        ` : ''}
                    </div>
                    

                    </div>
                    
                    <div class="mt-6 bg-stone-800 text-white p-6 rounded-lg shadow-lg">
                        <div class="flex flex-col md:flex-row items-center justify-center md:justify-around gap-6 md:gap-12">
                            <div class="text-center">
                                <h3 class="font-semibold text-base uppercase tracking-wider text-yellow-300">Deadline to Complete</h3>
                                <div id="countdown" class="flex justify-center gap-4 sm:gap-6 text-2xl sm:text-4xl mt-2">
                                    <div><span id="days" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Days</span></div>
                                    <div><span id="hours" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Hours</span></div>
                                    <div><span id="minutes" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Minutes</span></div>
                                    <div><span id="seconds" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Seconds</span></div>
                                </div>
                            </div>
                            <div class="hidden md:block w-px h-16 bg-stone-600"></div>
                            <div class="text-center flex items-center gap-4">
                                <svg class="w-12 h-12 text-yellow-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="text-left">
                                     <p class="text-lg font-bold text-white">1000 Points</p>
                                     <p class="text-sm text-stone-300">in the SLAP Dojo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border-2 border-stone-200">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <!-- Left Column: Materials -->
                        <div class="space-y-8">
                            <div>
                                <h4 class="text-xl font-semibold mb-3 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m2-10a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Video Materials
                                </h4>
                                <div id="challenge-video-container">
                                    <!-- Video content will be rendered here -->
                                </div>
                            </div>

                            <div>
                                <h4 class="text-xl font-semibold mb-3 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                    </svg>
                                    Audio Materials
                                </h4>
                                <div id="challenge-audio-container">
                                    <!-- Audio content will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Quiz -->
                        <div class="flex flex-col">
                            <h4 class="text-xl font-semibold mb-3 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                The Challenge Quiz
                            </h4>
                            <div id="quiz-container" class="bg-stone-50 p-6 rounded-lg border border-stone-200 flex-grow min-h-[400px]">
                                <!-- Quiz content will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Challenge Content Edit Modal -->
                <div id="challenge-edit-modal" class="modal-overlay">
                    <div class="modal-content max-w-2xl">
                        <div class="modal-header">
                            <h4>Editar Conteúdo do Desafio</h4>
                            <button data-action="close-challenge-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="challenge-content-form">
                            <div class="space-y-6">
                                <div>
                                    <label class="font-medium text-sm">URL do Vídeo (Cloudinary)</label>
                                    <input type="url" id="challenge-video-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                    <p class="text-xs text-stone-500 mt-1">Deixe em branco para remover o vídeo</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL do Áudio 1 (Cloudinary)</label>
                                    <input type="url" id="challenge-audio1-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL do Áudio 2 (Cloudinary)</label>
                                    <input type="url" id="challenge-audio2-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Mês do Módulo</label>
                                    <input type="text" id="challenge-month" class="form-input" placeholder="Ex: JANEIRO 2025">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data Limite (Deadline)</label>
                                    <input type="datetime-local" id="challenge-deadline" class="form-input">
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" data-action="close-challenge-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar Conteúdo</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            initializePedagogicalChallenge();
        }

        // --- Pedagogical Challenge Implementation ---
        let challengeContent = {
            videoUrl: '',
            audio1Url: '',
            audio2Url: '',
            month: 'MONTHLY MODULE',
            deadline: null
        };

        let teacherName = '';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        const questionsInChallenge = 25;

        const fullQuizData = [
            { q: "Vygotsky's ZPD is best described as a...", o: ["A fixed student level", "A physical space for learning", "A metaphorical space of potential growth", "A set of learning objectives"], a: 2, e: "ZPD is not a physical place or a fixed level, but a conceptual space where learning potential is activated through guidance." },
            { q: "The 'proximal' in ZPD refers to...", o: ["The proximity of the student to the teacher", "What is close to being mastered by the learner", "The next topic in the syllabus", "The end goal of the course"], a: 1, e: "'Proximal' means 'nearby' or 'next', indicating skills the learner is ready to acquire with help." },
            { q: "Which concept is intrinsically linked to ZPD and acts as the mechanism for learning within it?", o: ["Rote memorization", "Scaffolding", "Independent study", "Summative assessment"], a: 1, e: "Scaffolding is the structured support provided by an MKO (More Knowledgeable Other) that enables a learner to navigate their ZPD." },
            { q: "Who can be considered a 'More Knowledgeable Other' (MKO)?", o: ["Only the certified teacher", "Only a native speaker", "Anyone with more expertise, including peers or technology", "Only a parent or guardian"], a: 2, e: "An MKO is anyone or anything that has a better understanding or a higher ability level, including teachers, advanced peers, or even a well-designed app." },
            { q: "What is the primary goal of instruction within the ZPD?", o: ["To make tasks easier for the student", "To internalize skills, making the student independent", "To ensure the student never makes a mistake", "To accelerate through the curriculum"], a: 1, e: "The ultimate goal is for the learner to internalize the guided process, turning what was once achievable with help into an independent skill." },
            { q: "What typically happens when a learning task is far *below* a student's ZPD?", o: ["Anxiety and frustration", "Optimal learning", "Boredom and disengagement", "Internalization of skills"], a: 2, e: "Tasks that are too easy and already mastered lead to boredom, as they don't provide a challenge." },
            { q: "What typically happens when a learning task is far *above* a student's ZPD?", o: ["Rapid skill acquisition", "Frustration and anxiety", "Increased student confidence", "Effective peer collaboration"], a: 1, e: "Tasks that are too difficult, even with help, cause frustration and can hinder the learning process." },
            { q: "Vygotsky's theory is a form of...", o: ["Behaviorism", "Cognitivism", "Social constructivism", "Humanism"], a: 2, e: "Social constructivism posits that knowledge is constructed through social interaction." },
            { q: "The ZPD is best understood as a concept that is...", o: ["Static and measurable", "Fixed for each age group", "Dynamic and constantly changing", "Irrelevant to adult learners"], a: 2, e: "As a learner acquires new skills, their ZPD shifts. It is a dynamic, not static, concept." },
            { q: "The lower limit of the ZPD represents...", o: ["What a learner can do with assistance", "The learner's potential development", "What a learner can do independently", "The instructional goal"], a: 2, e: "The lower limit is defined by the skills that the student has already mastered and can perform without any help." },
            { q: "The upper limit of the ZPD represents...", o: ["Tasks that are impossible for the learner", "What the learner can achieve with guidance", "Skills the learner has already mastered", "The starting point of instruction"], a: 1, e: "The upper limit is the most a learner can achieve at that moment, but only with the help of an MKO." },
            { q: "The ZPD bridges the gap between...", o: ["Social speech and private speech", "Actual development and potential development", "Teacher and student", "Theory and practice"], a: 1, e: "It represents the space between what is known (actual development) and what could be known with help (potential development)." },
            { q: "Applying ZPD in the classroom requires teachers to first...", o: ["Group students by age", "Deliver a standardized lecture", "Accurately assess students' current abilities", "Provide the final answers"], a: 2, e: "To identify a student's ZPD, a teacher must first understand what the student can already do on their own." },
            { q: "The concept of ZPD challenges the sole reliance on...", o: ["Formative assessment", "Collaborative projects", "Standardized, independent testing", "Peer tutoring"], a: 2, e: "Standardized tests only measure what a student can do alone, ignoring their potential for growth with assistance." },
            { q: "Scaffolding, as a teaching strategy, should be...", o: ["Permanent and consistent", "The same for all students", "Temporary and gradually removed", "Used only for difficult subjects"], a: 2, e: "The goal of scaffolding is to provide support only when needed and then fade it away as the learner becomes more competent." },
            { q: "Which of the following is a classic example of scaffolding?", o: ["Letting the student struggle alone", "Giving the student the correct answer immediately", "Breaking a complex task into smaller, manageable steps", "Assigning extra homework"], a: 2, e: "Breaking down a task is a key scaffolding technique to make complex skills more accessible." },
            { q: "The term 'scaffolding' was coined by...", o: ["Lev Vygotsky", "Jean Piaget", "Jerome Bruner", "B.F. Skinner"], a: 2, e: "While inspired by Vygotsky's ZPD, the term 'scaffolding' was actually introduced by Jerome Bruner." },
            { q: "What is the process of gradually removing scaffolding called?", o: ["Fading", "Zoning", "Modeling", "Receding"], a: 0, e: "Fading is the term used for the gradual withdrawal of support as the learner's proficiency increases." },
            { q: "A teacher demonstrating how to solve a math problem before students try it is an example of...", o: ["Summative assessment", "Modeling, a scaffolding technique", "Independent learning", "Trial and error"], a: 1, e: "Modeling is a form of scaffolding where the expert demonstrates the process for the learner." },
            { q: "Can a well-designed software application function as a More Knowledgeable Other (MKO)?", o: ["No, an MKO must be a human", "Yes, if it provides guidance and feedback", "Only if it has artificial intelligence", "Only for teaching basic facts"], a: 1, e: "An MKO can be anything or anyone with more knowledge on the task, including technology like apps or computer programs." },
            { q: "In a collaborative learning group, a more advanced peer can act as an...", o: ["Obstacle", "MKO (More Knowledgeable Other)", "Formal assessor", "Distraction"], a: 1, e: "Peer-to-peer learning is a powerful application of Vygotsky's theory, where students serve as MKOs for each other." },
            { q: "According to Vygotsky, what is the most important 'psychological tool' for cognitive development?", o: ["Memory", "Language", "Logic", "Attention"], a: 1, e: "Vygotsky viewed language as the primary tool that shapes thought and enables higher-order cognitive functions." },
            { q: "Vygotsky saw a child's 'private speech' (talking to oneself) as...", o: ["A sign of immaturity", "A tool for problem-solving and self-regulation", "A meaningless activity", "A symptom of social isolation"], a: 1, e: "Unlike Piaget, Vygotsky believed private speech is a crucial step in internalizing thought and directing one's own actions." },
            { q: "How did Vygotsky's view of private speech differ from Piaget's?", o: ["Vygotsky saw it as social, Piaget as egocentric", "Vygotsky saw it as useless, Piaget as vital", "They had the same view", "Piaget didn't study private speech"], a: 0, e: "Piaget viewed it as 'egocentric speech' that fades away, while Vygotsky saw it as a cognitive tool that becomes 'inner speech'." },
            { q: "According to Vygotsky, thought and language...", o: ["Are identical from birth", "Develop independently at first and then merge", "Language is a byproduct of thought", "Thought is a byproduct of language"], a: 1, e: "He proposed that in early development, thought is non-verbal and speech is non-intellectual. They merge around age two." }
        ];

        function initializePedagogicalChallenge() {
            loadChallengeContent();
            renderChallengeContent();
            initializeCountdown();
            showQuizWelcome();
        }

        function loadChallengeContent() {
            const saved = localStorage.getItem('slap-challenge-content');
            if (saved) {
                challengeContent = JSON.parse(saved);
            } else {
                // Default content
                challengeContent = {
                    videoUrl: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751160446/Vygotksy_s_Zone_of_Proximal_Development_Explained_in_4_minutes_n3dmpt.mp4',
                    audio1Url: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751161824/zdp1_yldo65.mp3',
                    audio2Url: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751162058/ZDP2_jfyspg.mp3',
                    month: 'JANEIRO 2025',
                    deadline: null
                };
                saveChallengeContent();
            }
        }

        function saveChallengeContent() {
            localStorage.setItem('slap-challenge-content', JSON.stringify(challengeContent));
        }

        function renderChallengeContent() {
            renderVideoContent();
            renderAudioContent();
            updateChallengeHeader();
        }

        function updateChallengeHeader() {
            const monthDisplay = document.getElementById('challenge-month-display');
            if (monthDisplay && challengeContent.month) {
                monthDisplay.textContent = challengeContent.month;
            }
        }

        function renderVideoContent() {
            const container = document.getElementById('challenge-video-container');
            if (challengeContent.videoUrl) {
                container.innerHTML = `
                    <div class="mb-4">
                        <p class="font-medium text-stone-700 mb-2">Understanding ZPD</p>
                        <div class="aspect-video bg-stone-200 rounded-lg overflow-hidden">
                            <video controls class="w-full h-full">
                                <source src="${challengeContent.videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-stone-500">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m2-10a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p>Nenhum vídeo configurado</p>
                        ${currentUserRole === 'admin' ? '<p class="text-xs mt-1">Configure um vídeo através do botão "Editar Conteúdo"</p>' : ''}
                    </div>
                `;
            }
        }

        function renderAudioContent() {
            const container = document.getElementById('challenge-audio-container');
            let audioHtml = '';

            if (challengeContent.audio1Url) {
                audioHtml += `
                    <div class="mb-4">
                        <p class="font-medium text-stone-700 mb-2">Audio 1</p>
                        ${createAudioPlayer(challengeContent.audio1Url, 'audio1')}
                    </div>
                `;
            }

            if (challengeContent.audio2Url) {
                audioHtml += `
                    <div class="mb-4">
                        <p class="font-medium text-stone-700 mb-2">Audio 2</p>
                        ${createAudioPlayer(challengeContent.audio2Url, 'audio2')}
                    </div>
                `;
            }

            if (!challengeContent.audio1Url && !challengeContent.audio2Url) {
                audioHtml = `
                    <div class="text-center py-8 text-stone-500">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                        <p>Nenhum áudio configurado</p>
                        ${currentUserRole === 'admin' ? '<p class="text-xs mt-1">Configure áudios através do botão "Editar Conteúdo"</p>' : ''}
                    </div>
                `;
            }

            container.innerHTML = audioHtml;
            initializeAudioPlayers();
        }

        function createAudioPlayer(audioUrl, playerId) {
            return `
                <div class="audio-player-container" data-player="${playerId}">
                    <button class="play-pause-button">
                        <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                        <svg class="pause-icon hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                    </button>
                    <span class="time-display">0:00 / 0:00</span>
                    <input type="range" class="progress-bar" value="0" step="1">
                    <audio class="audio-element" preload="metadata" src="${audioUrl}"></audio>
                </div>
            `;
        }

        function initializeAudioPlayers() {
            const players = document.querySelectorAll('.audio-player-container');
            
            players.forEach(container => {
                const audio = container.querySelector('.audio-element');
                const playButton = container.querySelector('.play-pause-button');
                const playIcon = container.querySelector('.play-icon');
                const pauseIcon = container.querySelector('.pause-icon');
                const progressBar = container.querySelector('.progress-bar');
                const timeDisplay = container.querySelector('.time-display');

                audio.addEventListener('loadedmetadata', () => {
                    progressBar.max = audio.duration;
                    updateTimeDisplay();
                });

                audio.addEventListener('timeupdate', () => {
                    progressBar.value = audio.currentTime;
                    updateTimeDisplay();
                });

                playButton.addEventListener('click', () => {
                    if (audio.paused) {
                        audio.play();
                        playIcon.classList.add('hidden');
                        pauseIcon.classList.remove('hidden');
                    } else {
                        audio.pause();
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                    }
                });

                progressBar.addEventListener('input', () => {
                    audio.currentTime = progressBar.value;
                });

                function updateTimeDisplay() {
                    const current = formatTime(audio.currentTime);
                    const duration = formatTime(audio.duration);
                    timeDisplay.textContent = `${current} / ${duration}`;
                }

                function formatTime(seconds) {
                    if (isNaN(seconds)) return '0:00';
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }
            });
        }

        function openChallengeContentForm() {
            const modal = document.getElementById('challenge-edit-modal');
            const form = document.getElementById('challenge-content-form');
            
            // Pre-fill form
            document.getElementById('challenge-video-url').value = challengeContent.videoUrl || '';
            document.getElementById('challenge-audio1-url').value = challengeContent.audio1Url || '';
            document.getElementById('challenge-audio2-url').value = challengeContent.audio2Url || '';
            document.getElementById('challenge-month').value = challengeContent.month || '';
            
            // Pre-fill deadline
            if (challengeContent.deadline) {
                const date = new Date(challengeContent.deadline);
                const formattedDate = date.toISOString().slice(0, 16);
                document.getElementById('challenge-deadline').value = formattedDate;
            }
            
            modal.classList.add('visible');
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveChallengeContentForm();
                modal.classList.remove('visible');
            };
        }

        function saveChallengeContentForm() {
            const deadlineValue = document.getElementById('challenge-deadline').value;
            
            challengeContent = {
                videoUrl: document.getElementById('challenge-video-url').value.trim(),
                audio1Url: document.getElementById('challenge-audio1-url').value.trim(),
                audio2Url: document.getElementById('challenge-audio2-url').value.trim(),
                month: document.getElementById('challenge-month').value.trim() || 'MONTHLY MODULE',
                deadline: deadlineValue ? new Date(deadlineValue).getTime() : null
            };
            
            saveChallengeContent();
            renderChallengeContent();
            
            // Restart countdown with new deadline
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            initializeCountdown();
            
            // Reset form
            document.getElementById('challenge-content-form').reset();
        }

        let countdownInterval = null;

        function initializeCountdown() {
            // Use custom deadline or default to end of current month
            let deadline;
            if (challengeContent.deadline) {
                deadline = new Date(challengeContent.deadline);
            } else {
                const now = new Date();
                deadline = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            }
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = deadline - now;
                
                const daysEl = document.getElementById('days');
                const hoursEl = document.getElementById('hours');
                const minutesEl = document.getElementById('minutes');
                const secondsEl = document.getElementById('seconds');
                
                if (distance > 0) {
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    if (daysEl) daysEl.textContent = days.toString().padStart(2, '0');
                    if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
                    if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
                    if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
                } else {
                    if (daysEl) daysEl.textContent = '00';
                    if (hoursEl) hoursEl.textContent = '00';
                    if (minutesEl) minutesEl.textContent = '00';
                    if (secondsEl) secondsEl.textContent = '00';
                }
            }
            
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function showQuizWelcome() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <svg class="w-16 h-16 mx-auto mb-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    <h3 class="text-xl font-bold mb-2">Ready for the Challenge?</h3>
                    <p class="text-stone-600 mb-6">Study the materials above, then take the quiz to test your knowledge!</p>
                    <button onclick="window.startQuiz()" class="primary-btn w-auto mx-auto">Start Quiz</button>
                </div>
            `;
        }

        window.startQuiz = function() {
            // Generate random questions
            const shuffled = fullQuizData.sort(() => Math.random() - 0.5);
            quizQuestions = shuffled.slice(0, questionsInChallenge);
            currentQuestionIndex = 0;
            
            showNameInput();
        }

        function showNameInput() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <h3 class="text-xl font-bold mb-4">Enter Your Name</h3>
                    <input type="text" id="teacher-name-input" class="form-input mb-4 max-w-sm mx-auto" placeholder="Your full name" required>
                    <button onclick="window.submitName()" class="primary-btn w-auto mx-auto">Continue</button>
                </div>
            `;
        }

        window.submitName = function() {
            const nameInput = document.getElementById('teacher-name-input');
            teacherName = nameInput.value.trim();
            
            if (teacherName) {
                showQuestion();
            } else {
                alert('Please enter your name to continue.');
            }
        }

        function showQuestion() {
            const question = quizQuestions[currentQuestionIndex];
            if (!question) {
                console.error('Question not found at index:', currentQuestionIndex);
                return;
            }
            const quizContainer = document.getElementById('quiz-container');
            
            quizContainer.innerHTML = `
                <div class="h-full flex flex-col">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-stone-600">Question ${currentQuestionIndex + 1} of ${questionsInChallenge}</span>
                            <span class="text-sm font-medium text-violet-600">${Math.round(((currentQuestionIndex + 1) / questionsInChallenge) * 100)}%</span>
                        </div>
                        <div class="w-full bg-stone-200 rounded-full h-2">
                            <div class="bg-violet-600 h-2 rounded-full transition-all duration-300" style="width: ${((currentQuestionIndex + 1) / questionsInChallenge) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="flex-grow flex flex-col justify-center">
                        <h3 class="text-lg font-semibold mb-6">${question.q}</h3>
                        <div id="quiz-options" class="space-y-2">
                            ${question.o.map((option, index) => `
                                <button class="quiz-option" onclick="window.selectAnswer(${index})">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="explanation" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-blue-800"></p>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button onclick="window.previousQuestion()" class="secondary-btn ${currentQuestionIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentQuestionIndex === 0 ? 'disabled' : ''}>Previous</button>
                        <button id="next-btn" onclick="window.nextQuestion()" class="primary-btn w-auto hidden">Next Question</button>
                    </div>
                </div>
            `;
        }

        window.selectAnswer = function(selectedIndex) {
            const question = quizQuestions[currentQuestionIndex];
            if (!question) {
                console.error('Question not found at index:', currentQuestionIndex);
                return;
            }
            
            const options = document.querySelectorAll('.quiz-option');
            const explanation = document.getElementById('explanation');
            const nextBtn = document.getElementById('next-btn');
            
            // Disable all options
            options.forEach(option => option.disabled = true);
            
            // Show correct/incorrect
            options.forEach((option, index) => {
                if (index === question.a) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && selectedIndex !== question.a) {
                    option.classList.add('incorrect');
                }
            });
            
            // Show explanation
            explanation.querySelector('p').textContent = question.e;
            explanation.classList.remove('hidden');
            
            // Show next button
            nextBtn.classList.remove('hidden');
            
            // Track answer
            quizQuestions[currentQuestionIndex].userAnswer = selectedIndex;
        }

        window.nextQuestion = function() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex < questionsInChallenge) {
                showQuestion();
            } else {
                showResults();
            }
        }

        window.previousQuestion = function() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function showResults() {
            const correctAnswers = quizQuestions.filter(q => q.userAnswer === q.a).length;
            const percentage = Math.round((correctAnswers / questionsInChallenge) * 100);
            const passed = percentage >= 70;
            
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <div class="mb-6">
                        ${passed ? 
                            '<svg class="w-20 h-20 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' :
                            '<svg class="w-20 h-20 mx-auto mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
                        }
                        <h2 class="text-2xl font-bold mb-2 ${passed ? 'text-green-600' : 'text-red-600'}">${passed ? 'Congratulations!' : 'Keep Studying!'}</h2>
                        <p class="text-stone-600 mb-4">${teacherName}, you scored ${correctAnswers}/${questionsInChallenge} (${percentage}%)</p>
                        ${passed ? 
                            '<p class="text-green-600 font-medium mb-6">You have successfully completed this month\'s pedagogical challenge!</p>' :
                            '<p class="text-red-600 font-medium mb-6">You need 70% or higher to pass. Review the materials and try again!</p>'
                        }
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="window.startQuiz()" class="secondary-btn w-auto mx-auto">Try Again</button>
                        <button onclick="showQuizWelcome()" class="primary-btn w-auto mx-auto">Back to Start</button>
                    </div>
                </div>
            `;
        }

        // --- Guidelines Functions ---
        function renderDiretrizesSection() {
            document.getElementById('main-title').textContent = 'Diretrizes SLAP';
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="mb-6 flex justify-between items-center">
                        <input type="text" id="guidelines-search" class="guidelines-search" 
                               placeholder="Buscar diretrizes..." 
                               oninput="filterGuidelines(this.value)">
                        ${currentUserRole === 'admin' ? `
                        <button class="primary-btn w-auto ml-4" data-action="add-guideline">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar Diretriz
                        </button>
                        ` : ''}
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h2 class="text-xl font-bold text-green-600 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Boas Práticas
                            </h2>
                            <div id="good-practices-container">
                                <!-- Good practices will be rendered here -->
                            </div>
                        </div>
                        
                        <div>
                            <h2 class="text-xl font-bold text-red-600 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Itens Proibidos
                            </h2>
                            <div id="prohibited-items-container">
                                <!-- Prohibited items will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guideline Modal -->
                    <div id="guideline-modal" class="modal-overlay">
                        <div class="modal-content max-w-md">
                            <div class="modal-header">
                                <h4 id="guideline-modal-title">Nova Diretriz</h4>
                                <button data-action="close-guideline-modal" class="modal-close-btn">&times;</button>
                            </div>
                            <form id="guideline-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="font-medium text-sm">Tipo</label>
                                        <select id="guideline-type" class="form-input" required>
                                            <option value="good-practice">Boa Prática</option>
                                            <option value="prohibited">Item Proibido</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Título</label>
                                        <input type="text" id="guideline-title" class="form-input" required>
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Descrição</label>
                                        <textarea id="guideline-description" rows="4" class="form-input" required></textarea>
                                    </div>
                                    <div class="flex justify-end gap-2">
                                        <button type="button" data-action="close-guideline-modal" class="secondary-btn">Cancelar</button>
                                        <button type="submit" class="primary-btn w-auto">Salvar</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Highlight Modal -->
                <div id="monthly-highlight-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4>Editar Destaque do Mês</h4>
                            <button data-action="close-highlight-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="monthly-highlight-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">Nome do Funcionário</label>
                                    <input type="text" id="highlight-name" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL da Foto</label>
                                    <input type="url" id="highlight-photo-url" class="form-input" placeholder="https://exemplo.com/foto.jpg" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descrição</label>
                                    <textarea id="highlight-description" rows="4" class="form-input" placeholder="Descreva os méritos e conquistas..." required></textarea>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Premiação</label>
                                    <input type="text" id="highlight-award" class="form-input" placeholder="Ex: R$ 500 em vale-compras">
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" data-action="close-highlight-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            loadGuidelines();
        }

        let guidelines = {
            goodPractices: [],
            prohibitedItems: []
        };

        function loadGuidelines() {
            // Load from localStorage or initialize with sample data
            const savedGuidelines = localStorage.getItem('slap-guidelines');
            if (savedGuidelines) {
                guidelines = JSON.parse(savedGuidelines);
            } else {
                guidelines = {
                    goodPractices: [
                        { id: '1', title: 'Pontualidade nas Aulas', description: 'Sempre chegue às aulas com pelo menos 5 minutos de antecedência para preparar o ambiente e receber os alunos adequadamente.' },
                        { id: '2', title: 'Feedback Construtivo', description: 'Ofereça feedback específico e encorajador aos alunos, focando em aspectos que podem ser melhorados.' },
                        { id: '3', title: 'Material Organizado', description: 'Mantenha todos os materiais didáticos organizados e facilmente acessíveis durante as aulas.' },
                        { id: '4', title: 'Comunicação Clara', description: 'Use linguagem simples e clara, adaptando a complexidade ao nível dos alunos.' }
                    ],
                    prohibitedItems: [
                        { id: '1', title: 'Uso de Celular Durante Aulas', description: 'É proibido o uso de dispositivos móveis para fins pessoais durante o período de aula.' },
                        { id: '2', title: 'Linguagem Inadequada', description: 'Evite o uso de gírias excessivas ou linguagem informal que possa prejudicar o aprendizado.' },
                        { id: '3', title: 'Atraso Frequente', description: 'Atrasos constantes são inaceitáveis e prejudicam o andamento das atividades pedagógicas.' },
                        { id: '4', title: 'Material Não Aprovado', description: 'Não utilize materiais didáticos que não tenham sido aprovados pela coordenação pedagógica.' }
                    ]
                };
                saveGuidelines();
            }
            renderGuidelines();
        }

        function renderGuidelines(filter = '') {
            const goodPracticesContainer = document.getElementById('good-practices-container');
            const prohibitedItemsContainer = document.getElementById('prohibited-items-container');
            
            const filteredGoodPractices = guidelines.goodPractices.filter(item => 
                item.title.toLowerCase().includes(filter.toLowerCase()) || 
                item.description.toLowerCase().includes(filter.toLowerCase())
            );
            
            const filteredProhibitedItems = guidelines.prohibitedItems.filter(item => 
                item.title.toLowerCase().includes(filter.toLowerCase()) || 
                item.description.toLowerCase().includes(filter.toLowerCase())
            );
            
            goodPracticesContainer.innerHTML = filteredGoodPractices.map((item, index) => `
                <div class="guideline-card good-practice">
                    <div class="guideline-header">
                        <svg class="guideline-icon w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <div class="flex-1">
                            <h3 class="guideline-title">${item.title}</h3>
                        </div>
                        ${currentUserRole === 'admin' ? `
                        <button class="danger-btn !text-xs !py-1 !px-2 ml-2" onclick="deleteGuideline('goodPractices', ${guidelines.goodPractices.indexOf(item)})">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                    <p class="guideline-description">${item.description}</p>
                </div>
            `).join('');
            
            prohibitedItemsContainer.innerHTML = filteredProhibitedItems.map((item, index) => `
                <div class="guideline-card prohibited">
                    <div class="guideline-header">
                        <svg class="guideline-icon w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        <div class="flex-1">
                            <h3 class="guideline-title">${item.title}</h3>
                        </div>
                        ${currentUserRole === 'admin' ? `
                        <button class="danger-btn !text-xs !py-1 !px-2 ml-2" onclick="deleteGuideline('prohibitedItems', ${guidelines.prohibitedItems.indexOf(item)})">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                    <p class="guideline-description">${item.description}</p>
                </div>
            `).join('');
            
            // Show/hide sections based on search results
            const goodPracticesSection = document.querySelector('.grid > div:first-child');
            const prohibitedSection = document.querySelector('.grid > div:last-child');
            
            if (filter && filteredGoodPractices.length === 0) {
                goodPracticesSection.style.display = 'none';
            } else {
                goodPracticesSection.style.display = 'block';
            }
            
            if (filter && filteredProhibitedItems.length === 0) {
                prohibitedSection.style.display = 'none';
            } else {
                prohibitedSection.style.display = 'block';
            }
        }

        function filterGuidelines(searchTerm) {
            renderGuidelines(searchTerm);
        }
        
        function openGuidelineForm() {
            const modal = document.getElementById('guideline-modal');
            modal.classList.add('visible');
        }

        function deleteGuideline(type, index) {
            const itemTitle = guidelines[type][index].title;
            
            if (confirm(`Tem certeza que deseja excluir "${itemTitle}"?`)) {
                guidelines[type].splice(index, 1);
                saveGuidelines();
                renderGuidelines();
            }
        }

        // --- ENGLISH QUIZ SECTION ---
        const quizData = [
            { question: "I wish I ___ go to the party last night.", options: ["could", "could have", "can", "was able to"], correctAnswer: 1, explanation: "Para expressar arrependimento sobre o passado, usamos 'wish + could have + past participle'." },
            { question: "She's really good ___ playing the piano.", options: ["in", "at", "on", "for"], correctAnswer: 1, explanation: "A preposição 'at' é usada com a expressão 'good at' para habilidades." },
            { question: "By the time we arrived, the meeting ___ already ___.", options: ["has, started", "had, started", "was, starting", "would, start"], correctAnswer: 1, explanation: "O Past Perfect (had + past participle) indica uma ação que aconteceu antes de outra no passado." },
            { question: "If I ___ you, I would accept the job offer.", options: ["am", "was", "were", "will be"], correctAnswer: 2, explanation: "No Second Conditional, sempre usamos 'were' para todas as pessoas após 'if I'." },
            { question: "The word 'ubiquitous' means ___.", options: ["Rare", "Everywhere", "Beautiful", "Expensive"], correctAnswer: 1, explanation: "Ubiquitous significa presente em todo lugar, onipresente." },
            { question: "You'll get used to ___ on the left.", options: ["drive", "be driving", "driving", "driven"], correctAnswer: 2, explanation: "A estrutura 'get used to' é seguida por um verbo no gerúndio (-ing)." },
            { question: "The word 'gregarious' means ___.", options: ["Shy", "Sociable", "Angry", "Intelligent"], correctAnswer: 1, explanation: "Uma pessoa 'gregarious' é sociável e gosta de estar com outras pessoas." },
            { question: "It is ___ to see you again.", options: ["a pleasure", "pleasure", "the pleasure", "pleasured"], correctAnswer: 0, explanation: "A expressão correta é 'It is a pleasure...'." },
            { question: "I am not ___ to lift that box.", options: ["enough strong", "strong enough", "too strong", "so strong"], correctAnswer: 1, explanation: "A estrutura correta é adjetivo + 'enough' (strong enough)." },
            { question: "She insisted ___ paying for the meal.", options: ["on", "in", "to", "for"], correctAnswer: 0, explanation: "O verbo 'insist' é seguido pela preposição 'on'." },
            { question: "To 'spill the beans' means to ___.", options: ["Be clumsy", "Reveal a secret", "Eat quickly", "Waste money"], correctAnswer: 1, explanation: "A expressão 'spill the beans' significa revelar um segredo ou contar uma informação confidencial." },
            { question: "Hardly ___ I got home when the phone rang.", options: ["had", "did", "have", "was"], correctAnswer: 0, explanation: "Quando uma frase começa com 'Hardly', usamos a inversão: 'Hardly had I... when...'." },
            { question: "The word 'meticulous' is a synonym for ___.", options: ["Careless", "Fast", "Careful and precise", "Huge"], correctAnswer: 2, explanation: "'Meticulous' significa ser muito cuidadoso, prestando atenção a todos os detalhes." },
            { question: "I'm ___ with this result.", options: ["disappoint", "disappointing", "disappointed", "disappointment"], correctAnswer: 2, explanation: "Adjetivos terminados em '-ed' (disappointed) descrevem como alguém se sente." },
            { question: "There are ___ people here than at the last meeting.", options: ["less", "fewer", "little", "much"], correctAnswer: 1, explanation: "'Fewer' é usado para substantivos contáveis (people), enquanto 'less' é para incontáveis." },
            { question: "The opposite of 'cautious' is ___.", options: ["Careful", "Brave", "Reckless", "Quiet"], correctAnswer: 2, explanation: "'Reckless' (imprudente) é o oposto de 'cautious' (cauteloso)." },
            { question: "I'd like to ___ a complaint.", options: ["do", "have", "make", "give"], correctAnswer: 2, explanation: "A colocação correta é 'make a complaint'." },
            { question: "The phrasal verb 'to run out of something' means ___.", options: ["to have no more of something", "to run outside", "to exercise", "to leave quickly"], correctAnswer: 0, explanation: "'Run out of' significa esgotar o estoque de algo, não ter mais." },
            { question: "This soup is ___ hot to eat.", options: ["so", "such", "enough", "too"], correctAnswer: 3, explanation: "'Too' é usado antes de um adjetivo para indicar um excesso negativo." },
            { question: "The word 'obsolete' means ___.", options: ["Very modern", "No longer in use", "Very popular", "Complicated"], correctAnswer: 1, explanation: "Algo 'obsolete' está ultrapassado ou não é mais usado." },
            { question: "He reminded me ___ my appointment.", options: ["of", "to", "about", "for"], correctAnswer: 0, explanation: "A estrutura correta é 'remind someone of something'." },
            { question: "If you don't mind, I'd rather you ___ smoke in here.", options: ["don't", "didn't", "wouldn't", "not"], correctAnswer: 1, explanation: "Após 'I'd rather' + pronome, usamos o Simple Past ('didn't') para expressar uma preferência sobre a ação de outra pessoa." }
        ];

        let currentQuizQuestions = [];
        let currentEnglishQuestionIndex = 0;
        let quizScore = 0;

        function renderEnglishQuizSection() {
            document.getElementById('main-title').textContent = 'English Quiz';
            document.getElementById('main-description').textContent = 'Teste seus conhecimentos de inglês! Responda 10 perguntas e veja seu resultado.';
            
            contentArea.innerHTML = `
                <section id="quiz-container" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 max-w-3xl mx-auto w-full">
                    <!-- Quiz content will be injected here -->
                </section>
            `;
            startQuiz();
        }

        function startQuiz() {
            currentEnglishQuestionIndex = 0;
            quizScore = 0;
            quizData.sort(() => Math.random() - 0.5);
            currentQuizQuestions = quizData.slice(0, 10);
            displayQuestion();
        }
        
        function displayQuestion() {
            const quizContainer = document.getElementById('quiz-container');
            if (currentEnglishQuestionIndex < currentQuizQuestions.length) {
                const questionData = currentQuizQuestions[currentEnglishQuestionIndex];
                let optionsHtml = '';
                questionData.options.forEach((option, index) => {
                    optionsHtml += `<button class="quiz-option" onclick="selectAnswer(${index})">${option}</button>`;
                });

                quizContainer.innerHTML = `
                    <div id="quiz-content">
                         <div class="flex justify-between items-center mb-4">
                            <p class="text-sm font-semibold text-stone-500">Questão ${currentEnglishQuestionIndex + 1} de ${currentQuizQuestions.length}</p>
                            <p class="text-sm font-semibold text-[#F1D24B]">Pontuação: ${quizScore}</p>
                         </div>
                        <h3 class="text-xl font-bold mb-6 text-stone-800">${questionData.question}</h3>
                        <div id="quiz-options">${optionsHtml}</div>
                        <div id="feedback-area" class="mt-4"></div>
                        <div id="quiz-nav" class="mt-6 text-right"></div>
                    </div>
                `;
            } else {
                showQuizResult();
            }
        }

        function selectAnswer(selectedIndex) {
            const questionData = currentQuizQuestions[currentEnglishQuestionIndex];
            const options = document.querySelectorAll('#quiz-options .quiz-option');
            const feedbackArea = document.getElementById('feedback-area');
            const navArea = document.getElementById('quiz-nav');

            options.forEach(button => button.disabled = true);

            if (selectedIndex === questionData.correctAnswer) {
                quizScore++;
                options[selectedIndex].classList.add('correct');
                feedbackArea.innerHTML = `
                    <div class="quiz-feedback correct">
                        <p><strong>Correto!</strong> ${questionData.explanation}</p>
                    </div>`;
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[questionData.correctAnswer].classList.add('correct');
                feedbackArea.innerHTML = `
                     <div class="quiz-feedback incorrect">
                        <p><strong>Incorreto.</strong> A resposta certa é <strong>'${questionData.options[questionData.correctAnswer]}'</strong>. ${questionData.explanation}</p>
                    </div>`;
            }

            if (currentEnglishQuestionIndex < currentQuizQuestions.length - 1) {
                 navArea.innerHTML = `<button class="quiz-nav-button" onclick="nextQuestion()">Próxima Questão &rarr;</button>`;
            } else {
                 navArea.innerHTML = `<button class="quiz-nav-button" onclick="showQuizResult()">Ver Resultado</button>`;
            }
        }
        
        function nextQuestion() {
            currentEnglishQuestionIndex++;
            displayQuestion();
        }

        function showQuizResult() {
            const quizContainer = document.getElementById('quiz-container');
            const percentage = Math.round((quizScore / currentQuizQuestions.length) * 100);
            let resultMessage = '';
            let resultColor = '';

            if (percentage >= 90) {
                resultMessage = 'Excelente! Você tem um domínio avançado do inglês!';
                resultColor = 'text-green-600';
            } else if (percentage >= 70) {
                resultMessage = 'Muito bom! Você tem um bom conhecimento do inglês.';
                resultColor = 'text-blue-600';
            } else if (percentage >= 50) {
                resultMessage = 'Não está mal! Continue estudando para melhorar.';
                resultColor = 'text-yellow-600';
            } else {
                resultMessage = 'Continue praticando! O inglês requer dedicação constante.';
                resultColor = 'text-red-600';
            }

            quizContainer.innerHTML = `
                <div class="text-center">
                    <h2 class="text-3xl font-bold mb-4 text-stone-800">Quiz Finalizado!</h2>
                    <div class="text-6xl font-bold mb-4 ${resultColor}">${quizScore}/${currentQuizQuestions.length}</div>
                    <div class="text-2xl font-semibold mb-4 ${resultColor}">${percentage}%</div>
                    <p class="text-lg mb-6 ${resultColor}">${resultMessage}</p>
                    <button class="quiz-nav-button" onclick="startQuiz()">Tentar Novamente</button>
                </div>
            `;
        }

        // --- BRAINFLIP GAME SECTION ---
        const flashcardsData = [
            { front: "Teacher Talking Time (TTT)", back: "O tempo que o professor fala durante a aula. O ideal é minimizá-lo para maximizar o STT." },
            { front: "Student Talking Time (STT)", back: "O tempo que os alunos falam durante a aula. Um indicador chave de engajamento e prática." },
            { front: "Lexical Approach", back: "Metodologia que foca no ensino de 'chunks' de linguagem (collocations, fixed expressions) em vez de palavras isoladas." },
            { front: "Comprehensible Input", back: "Linguagem que os alunos conseguem entender, mesmo que contenha estruturas novas (i + 1, segundo Krashen)." },
            { front: "Teoria de Krashen", back: "Cinco hipóteses sobre a aquisição de segunda língua: Aquisição-Aprendizagem, Monitor, Ordem Natural, Input e Filtro Afetivo." },
            { front: "Scaffolding", back: "Suporte temporário dado pelo professor para ajudar o aluno a realizar uma tarefa que ele não faria sozinho, removido gradualmente." },
            { front: "Error Correction", back: "Estratégias para corrigir erros dos alunos, que podem ser diretas, indiretas, recasts, elicitation, etc., dependendo do estágio do erro." },
            { front: "CEFR (Common European Framework of Reference)", back: "Padrão internacional para descrever habilidades linguísticas, com níveis de A1 a C2 (Básico, Independente, Proficiente)." },
            { front: "PPP vs. TBL", back: "PPP é uma abordagem linear (apresenta, pratica, produz). TBL é mais comunicativa, focando em tarefas com um objetivo real." },
            { front: "Task-Based Learning (TBL)", back: "Abordagem onde a aprendizagem ocorre através da realização de tarefas significativas que envolvem a comunicação real da língua." },
            { front: "Dogme", back: "Abordagem de ensino 'unplugged', que minimiza materiais pré-fabricados e foca na linguagem emergente dos alunos." },
            { front: "Formative Assessment", back: "Avaliação contínua realizada durante o processo de aprendizagem para monitorar o progresso e fornecer feedback." },
            { front: "Andragogia", back: "Princípios da educação de adultos, que se diferenciam da pedagogia (educação de crianças) pela autonomia e experiência do aprendiz." },
            { front: "Metodologia ativa", back: "Abordagens de ensino que colocam o aluno no centro do processo, tornando-o protagonista da sua aprendizagem (ex: Aprendizagem Baseada em Projetos)." },
            { front: "Ensino híbrido (Blended Learning)", back: "Combinação de ensino presencial e online, utilizando diferentes modalidades para otimizar a aprendizagem." },
            { front: "CLIL (Content and Language Integrated Learning)", back: "Ensino de uma disciplina (ex: história, ciências) através de uma língua estrangeira, desenvolvendo conteúdo e habilidades linguísticas simultaneamente." },
            { front: "Warm-ups", back: "Atividades curtas no início da aula para engajar os alunos, ativar conhecimentos prévios e prepará-los para o tema." },
            { front: "Cool downs", back: "Atividades no final da aula para revisar o conteúdo, consolidar a aprendizagem ou relaxar e refletir." },
            { front: "ICQs / CCQs", back: "Perguntas curtas para verificar se os alunos entenderam as instruções (ICQs) ou o conceito (CCQs) apresentado." },
            { front: "Autonomy in Learning", back: "Capacidade do aluno de tomar controle de sua própria aprendizagem, definindo metas e escolhendo métodos." }
        ];

        let currentCardIndex = 0;
        let isFlipped = false;

        function renderBrainFlipSection() {
            document.getElementById('main-title').textContent = 'BrainFlip';
            document.getElementById('main-description').textContent = 'Flashcards pedagógicos para professores de inglês. Clique nas cartas para virar e aprender!';

            contentArea.innerHTML = `
                <section class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col items-center justify-center min-h-[70vh]">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-700 mb-8 mt-4 text-center">BrainFlip</h1>
                    <p class="text-lg text-stone-700 mb-8 text-center max-w-2xl">
                        Um jogo interativo de flashcards pedagógicos para professores de inglês. Clique nas cartas para virar e aprender!
                    </p>

                    <div class="flashcard-container mb-8">
                        <div id="flashcard" class="flashcard cursor-pointer" onclick="flipCard()">
                            <div id="flashcard-front" class="flashcard-face flashcard-front"></div>
                            <div id="flashcard-back" class="flashcard-face flashcard-back"></div>
                        </div>
                    </div>

                    <div class="flex items-center justify-center space-x-4 mb-8">
                        <button id="prev-btn" class="navigation-button-game" onclick="previousCard()">
                            Anterior
                        </button>
                        <span id="card-counter" class="text-xl font-semibold text-stone-800">1 / ${flashcardsData.length}</span>
                        <button id="next-btn" class="navigation-button-game" onclick="nextCard()">
                            Próximo
                        </button>
                    </div>
                </section>
            `;

            loadCard(0);
        }

        function loadCard(index) {
            currentCardIndex = index;
            isFlipped = false;
            
            const flashcard = document.getElementById('flashcard');
            const front = document.getElementById('flashcard-front');
            const back = document.getElementById('flashcard-back');
            const counter = document.getElementById('card-counter');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            // Reset flip state
            flashcard.classList.remove('flipped');
            
            // Load content
            front.textContent = flashcardsData[index].front;
            back.textContent = flashcardsData[index].back;
            
            // Update counter
            counter.textContent = `${index + 1} / ${flashcardsData.length}`;
            
            // Update button states
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === flashcardsData.length - 1;
        }

        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            flashcard.classList.toggle('flipped');
            isFlipped = !isFlipped;
        }

        function nextCard() {
            if (currentCardIndex < flashcardsData.length - 1) {
                loadCard(currentCardIndex + 1);
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                loadCard(currentCardIndex - 1);
            }
        }
        
        function saveGuideline(event) {
            event.preventDefault();
            
            const type = document.getElementById('guideline-type').value;
            const title = document.getElementById('guideline-title').value;
            const description = document.getElementById('guideline-description').value;
            
            const newGuideline = {
                id: Date.now().toString(),
                title: title,
                description: description
            };
            
            if (type === 'good-practice') {
                guidelines.goodPractices.push(newGuideline);
            } else {
                guidelines.prohibitedItems.push(newGuideline);
            }
            
            saveGuidelines();
            renderGuidelines();
            
            // Close modal and reset form
            document.getElementById('guideline-modal').classList.remove('visible');
            document.getElementById('guideline-form').reset();
        }

        function exportAlunosDoc() {
            let studentsList = '';
            const activeStudents = students.filter(s => s.status === 'Ativo');
            studentsList = activeStudents.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.status}</td>
                    <td>R$ ${parseFloat(s.amountPaid || 0).toFixed(2)}</td>
                    <td>${s.responsibleName || 'N/A'}</td>
                    <td>${s.responsibleEmail || 'N/A'}</td>
                    <td>${s.responsiblePhone || 'N/A'}</td>
                    <td>${s.emergencyContact || 'N/A'}</td>
                    <td>${s.emergencyPhone || 'N/A'}</td>
                    <td>${s.level || 'N/A'}</td>
                    <td>${s.birthDate || 'N/A'}</td>
                    <td>${s.address || 'N/A'}</td>
                    <td>${s.observations || 'N/A'}</td>
                </tr>
            `).join('');
            
            if (!studentsList) { studentsList = '<tr><td colspan="12">Nenhum aluno ativo encontrado.</td></tr>'; }
            
            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Lista Completa de Alunos - SLAP</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; }
                        h1 { color: #333; text-align: center; margin-bottom: 30px; }
                        .header-info { text-align: center; margin-bottom: 20px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .student-name { font-weight: bold; }
                        @media print {
                            body { margin: 10px; }
                            table { font-size: 10px; }
                            th, td { padding: 4px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Lista Completa de Alunos Ativos - SLAP</h1>
                    <div class="header-info">
                        <p>Data de Exportação: ${new Date().toLocaleDateString('pt-BR')}</p>
                        <p>Total de Alunos Ativos: ${activeStudents.length}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome do Aluno</th>
                                <th>Status</th>
                                <th>Valor Pago</th>
                                <th>Responsável</th>
                                <th>Email Responsável</th>
                                <th>Telefone Responsável</th>
                                <th>Contato Emergência</th>
                                <th>Tel. Emergência</th>
                                <th>Nível</th>
                                <th>Data Nascimento</th>
                                <th>Endereço</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentsList}
                        </tbody>
                    </table>
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>Documento gerado pelo Hub SLAP - Speaking Like a Pro</p>
                    </div>
                </body>
                </html>
            `;
            
            openHtmlInNewWindow("Lista Completa de Alunos", docHtml);
        }

        // Make functions globally accessible
        window.filterGuidelines = filterGuidelines;
        window.changeMonth = changeMonth;
        window.viewCalendarEvent = viewCalendarEvent;
        window.openCalendarEventForm = openCalendarEventForm;
        window.openGuidelineForm = openGuidelineForm;
        window.saveGuideline = saveGuideline;
        window.exportAlunosDoc = exportAlunosDoc;

        function saveGuidelines() {
            localStorage.setItem('slap-guidelines', JSON.stringify(guidelines));
        }

        // --- Monthly Highlight Functions ---
        let monthlyHighlight = null;

        function renderMonthlyHighlight() {
            const container = document.getElementById('monthly-highlight-content');
            const savedHighlight = localStorage.getItem('slap-monthly-highlight');
            
            if (savedHighlight) {
                monthlyHighlight = JSON.parse(savedHighlight);
            }

            if (monthlyHighlight && monthlyHighlight.name) {
                container.innerHTML = `
                    <div class="highlight-card">
                        <img src="${monthlyHighlight.photoUrl}" alt="${monthlyHighlight.name}" class="highlight-photo" onerror="this.src='https://via.placeholder.com/80x80/F1D24B/44403c?text=${monthlyHighlight.name.charAt(0)}'">
                        <div class="highlight-info">
                            <h5>${monthlyHighlight.name}</h5>
                            <p>${monthlyHighlight.description}</p>
                            ${monthlyHighlight.award ? `<div class="highlight-award"><strong>Premiação:</strong> ${monthlyHighlight.award}</div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="highlight-empty">
                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <p>Nenhum funcionário em destaque este mês</p>
                        ${currentUserRole === 'admin' ? '<p class="text-xs mt-1">Clique em "Editar" para adicionar</p>' : ''}
                    </div>
                `;
            }
        }

        function openMonthlyHighlightForm() {
            const modal = document.getElementById('monthly-highlight-modal');
            const form = document.getElementById('monthly-highlight-form');
            
            // Pre-fill form if there's existing data
            if (monthlyHighlight) {
                document.getElementById('highlight-name').value = monthlyHighlight.name || '';
                document.getElementById('highlight-photo-url').value = monthlyHighlight.photoUrl || '';
                document.getElementById('highlight-description').value = monthlyHighlight.description || '';
                document.getElementById('highlight-award').value = monthlyHighlight.award || '';
            } else {
                form.reset();
            }
            
            modal.classList.add('visible');
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveMonthlyHighlight();
                modal.classList.remove('visible');
            };
        }

        function saveMonthlyHighlight() {
            const name = document.getElementById('highlight-name').value;
            const photoUrl = document.getElementById('highlight-photo-url').value;
            const description = document.getElementById('highlight-description').value;
            const award = document.getElementById('highlight-award').value;
            
            monthlyHighlight = {
                name: name,
                photoUrl: photoUrl,
                description: description,
                award: award,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('slap-monthly-highlight', JSON.stringify(monthlyHighlight));
            renderMonthlyHighlight();
            
            // Reset form
            document.getElementById('monthly-highlight-form').reset();
        }

        // --- Welcome Message Functions ---
        function extractNameFromEmail(email) {
            if (!email) return 'Usuário';
            const name = email.split('@')[0];
            return name.split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
        }

        function updateWelcomeMessages(name) {
            // Wait for DOM to be fully ready
            function tryUpdate() {
                const welcomeMsg = document.getElementById('welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.textContent = `Bem-vindo, ${name}!`;
                }
                const headerWelcome = document.getElementById('header-welcome-message');
                if (headerWelcome) {
                    headerWelcome.innerHTML = `
                        <div class="text-sm font-medium">Welcome,</div>
                        <div class="text-lg font-bold">${name}</div>
                    `;
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', tryUpdate);
            } else {
                setTimeout(tryUpdate, 100);
            }
        }

        // --- Calendar Event Functions ---
        function openCalendarEventForm(eventId = null) {
            const modal = document.getElementById('calendar-event-modal');
            const form = document.getElementById('calendar-event-form');
            const title = document.getElementById('event-modal-title');
            
            title.textContent = eventId ? 'Editar Evento' : 'Novo Evento';
            
            if (eventId) {
                const event = calendarEvents.find(e => e.id === eventId);
                if (event) {
                    document.getElementById('event-title').value = event.title;
                    document.getElementById('event-date').value = event.date;
                    document.getElementById('event-time').value = event.time || '';
                    document.getElementById('event-type').value = event.type;
                    document.getElementById('event-description').value = event.description || '';
                }
            } else {
                form.reset();
            }
            
            modal.classList.add('visible');
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveCalendarEvent(eventId);
                modal.classList.remove('visible');
            };
        }

        function saveCalendarEvent(eventId = null) {
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value;
            
            if (eventId) {
                const eventIndex = calendarEvents.findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    calendarEvents[eventIndex] = { id: eventId, title, date, time, type, description };
                }
            } else {
                const newEvent = {
                    id: Date.now().toString(),
                    title,
                    date,
                    time,
                    type,
                    description
                };
                calendarEvents.push(newEvent);
            }
            
            saveCalendarEvents();
            renderCalendar();
        }

        function viewCalendarEvent(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (event) {
                openCalendarEventForm(eventId);
            }
        }

        function renderMenu() {
            const mainNav = document.getElementById('main-navigation');
            const menuItems = [
                { key: 'inicio', label: 'Início', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>', roles: null },
                { key: 'dojo', label: 'Dojo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M6.5 12.5h11"/><path d="M12 6.5v11"/><path d="M17.5 17.5 19 19"/><path d="M6.5 6.5 5 5"/><path d="M17.5 6.5 19 5"/><path d="M6.5 17.5 5 19"/><path d="M2 12C2 6.5 6.5 2 12 2s10 4.5 10 10-4.5 10-10 10S2 17.5 2 12Z"/><path d="M16 8h2"/><path d="M6 16H4"/></svg>', roles: null },
                { key: 'alunos', label: 'Alunos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>', roles: ['admin', 'pedagogico', 'financeiro', 'ap'] },
                { key: 'turmas', label: 'Turmas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'pedagogico', 'teacher', 'ap'] },
                { key: 'vips', label: 'VIPs', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>', roles: ['admin', 'pedagogico', 'teacher', 'ap'] },
                { key: 'grade', label: 'Grade', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>', roles: ['admin', 'ap', 'pedagogico', 'financeiro', 'teacher'] },
                { key: 'calendario', label: 'Calendário', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>', roles: ['admin', 'ap', 'pedagogico', 'financeiro', 'teacher', 'am'] },
                { key: 'desafio-pedagogico', label: 'Desafio Pedagógico', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>', roles: ['admin', 'pedagogico', 'teacher'] },
                { key: 'diretrizes', label: 'Diretrizes', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>', roles: ['admin', 'teacher'] },
                { key: 'english-quiz', label: 'English Quiz', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11H7l5-7 5 7h-2M9 11v6h6v-6M9 11l3-3 3 3"></path></svg>', roles: null },
                { key: 'brainflip', label: 'BrainFlip', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="7" rx="2" ry="2"></rect><path d="M5 15v4a2 2 0 0 0 2 2h4"></path><path d="M3 12h12"></path></svg>', roles: ['pedagogico', 'teacher'] },
                { key: 'tarefas', label: 'Tarefas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>', roles: ['admin', 'am', 'ap', 'pedagogico', 'financeiro', 'teacher'] },
                { key: 'cps', label: 'CPs', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>', roles: ['admin', 'pedagogico', 'ap'] },
                { key: 'eventos', label: 'Eventos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z"/><path d="M12.44 8.917a4 4 0 0 0-4.88 0C4.965 10.685 3 13.982 3 17.5V22h18v-4.5c0-3.518-1.965-6.815-4.56-8.583z"/></svg>', roles: ['admin', 'am', 'ap', 'pedagogico'] },
                { key: 'orcamentos', label: 'Orçamentos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>', roles: ['admin', 'am', 'financeiro'] },
                { key: 'banco-de-fotos', label: 'Banco de Fotos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>', roles: ['admin', 'am'] },
                { key: 'colaboradores', label: 'Colaboradores', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'pedagogico', 'financeiro'] },
                { key: 'cancelamentos', label: 'Cancelamentos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="18" x2="17" y2="12"/><line x1="17" y1="18" x2="23" y2="12"/></svg>', roles: ['admin', 'pedagogico', 'financeiro'] },
                { key: 'folha-pagamento', label: 'Folha de Pag.', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', roles: ['admin', 'financeiro'] }
            ];

            const menuItemsHTML = menuItems
                .filter(item => !item.roles || item.roles.includes(currentUserRole))
                .map(item => `<button data-target="${item.key}" class="nav-item w-full text-left px-4 py-2.5 rounded-lg flex items-center font-semibold">${item.icon}${item.label}</button>`)
                .join('');
            
            mainNav.innerHTML = menuItemsHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const pageRenderers = { 'inicio': renderInicioSection, 'alunos': renderAlunosSection, 'turmas': renderTurmasSection, 'vips': renderVipsSection, 'eventos': renderEventosSection, 'orcamentos': renderOrcamentosSection, 'tarefas': renderTarefasSection, 'grade': renderGradeSection, 'folha-pagamento': renderFolhaPagamentoSection, 'cancelamentos': renderCancelamentosSection, 'colaboradores': renderColaboradoresSection, 'banco-de-fotos': renderBancoDeFotosSection, 'cps': renderCPsSection, 'dojo': renderDojoSection, 'calendario': renderCalendarioSection, 'desafio-pedagogico': renderDesafioPedagogicoSection, 'diretrizes': renderDiretrizesSection, 'english-quiz': renderEnglishQuizSection, 'brainflip': renderBrainFlipSection };
            
            document.body.addEventListener('click', (event) => {
                // Close modals when clicking overlay or close button
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-calendar-modal"]')) {
                    document.getElementById('calendar-event-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-guideline-modal"]')) {
                    document.getElementById('guideline-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-highlight-modal"]')) {
                    document.getElementById('monthly-highlight-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-challenge-modal"]')) {
                    document.getElementById('challenge-edit-modal').classList.remove('visible');
                }
                
                const navTarget = event.target.closest('.nav-item');
                if (navTarget && !navTarget.disabled) {
                    const pageKey = navTarget.dataset.target;
                    if (pageKey && pageRenderers[pageKey]) {
                        pageRenderers[pageKey]();
                        setActiveNavItem(navTarget);
                    }
                }
                
                const actionTarget = event.target.closest('[data-action]');
                if (actionTarget) {
                    if(actionTarget.closest('.modal-content') && !['close-modal', 'export-vip-pef', 'export-turma-pef'].includes(actionTarget.dataset.action)) event.stopPropagation();
                    
                    const { action, id, collection, folderName, nivelId, aulaIndex, direction, unitId, lessonNumber, status } = actionTarget.dataset;
                    const actionHandlers = {
                        'open-signup': openSignUpModal,
                        'add-aluno': () => openAlunoForm(),
                        'view-aluno': () => openAlunoModal(id),
                        'edit-aluno': () => openAlunoForm(id),
                        'add-turma': () => openTurmaForm(),
                        'open-turma-pef': () => openTurmaPefModal(id),
                        'edit-turma': () => openTurmaForm(id),
                        'add-vip': () => openVipForm(),
                        'edit-vip': () => openVipForm(id),
                        'open-vip-pef': () => openVipPefModal(id),
                        'mark-attendance': () => {
                            const button = actionTarget;
                            const group = button.closest('.pef-status-btn-group');
                            if (!group) return;

                            if (button.classList.contains('active')) {
                                button.classList.remove('active', 'P', 'F', 'PP');
                            } else {
                                group.querySelectorAll('button').forEach(btn => btn.classList.remove('active', 'P', 'F', 'PP'));
                                button.classList.add('active', status);
                            }
                        },
                        'save-pef-lesson': () => savePefLesson(unitId, lessonNumber),
                        'add-event': openEventForm,
                        'view-event': () => openEventModal(id),
                        'edit-event': () => openEventForm(id),
                        'add-budget': openBudgetForm,
                        'view-budget': () => openBudgetModal(id),
                        'edit-budget': () => openBudgetForm(id),
                        'add-task': openTaskForm,
                        'add-collaborator': () => openCollaboratorForm(),
                        'edit-collaborator': () => openCollaboratorForm(id),
                        'add-schedule': openScheduleForm,
                        'view-schedule': () => openScheduleForm(id),
                        'add-expense': openExpenseForm,
                        'view-expense': () => openExpenseForm(id),
                        'add-cancelamento': openCancelamentoForm,
                        'view-cancelamento': () => openCancelamentoModal(id),
                        'edit-cancelamento': () => openCancelamentoForm(id),
                        'delete-item': () => deleteItem(collection, id),
                        'close-modal': closeFormModal,
                        'add-photo': openPhotoFormModal,
                        'add-folder': openFolderFormModal,
                        'delete-folder': () => deleteFolder(id, folderName),
                        'open-folder': () => renderPhotoGallery(folderName),
                        'back-to-folders': renderBancoDeFotosSection,
                        'toggle-cp-level': () => { const card = document.getElementById(`nivel-${id}`); if(card) { card.classList.toggle('open'); const icon = card.querySelector('svg'); icon.style.transform = card.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; } },
                        'add-nivel': () => openNivelForm(),
                        'edit-nivel': () => openNivelForm(id),
                        'reorder-cp': () => reorderCPLevel(id, direction),
                        'add-aula': () => openAulaForm(nivelId),
                        'edit-aula': () => openAulaForm(nivelId, aulaIndex),
                        'delete-aula': () => deleteAula(nivelId, aulaIndex),
                        'add-dojo-competitor': () => openDojoCompetitorForm(),
                        'edit-dojo-points': () => openDojoPointsForm(id),
                        'add-dojo-mission': openDojoMissionForm,
                        'export-alunos-doc': exportAlunosDoc,
                        'export-vip-pef': () => exportVipPef(id),
                        'export-turma-pef': () => exportTurmaPef(id),
                        'export-cps-doc': exportCPsDoc,
                        'add-calendar-event': openCalendarEventForm,
                        'view-calendar-event': () => viewCalendarEvent(id),
                        'edit-calendar-event': () => openCalendarEventForm(id),
                        'add-guideline': openGuidelineForm,
                        'edit-monthly-highlight': openMonthlyHighlightForm,
                        'edit-challenge-content': openChallengeContentForm,
                    };
                    if (actionHandlers[action]) {
                        actionHandlers[action]();
                    }
                }

                if(event.target.matches('input[type="checkbox"][data-action="toggle-task"]')) {
                    const taskId = event.target.dataset.id;
                    const isCompleted = event.target.checked;
                    toggleTaskCompletion(taskId, isCompleted);
                }
                 if(event.target.matches('input[type="checkbox"][data-action="toggle-expense"]')) {
                    const expenseId = event.target.dataset.id;
                    const isPaid = event.target.checked;
                    toggleExpensePaid(expenseId, isPaid);
                }
            });

            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('pending-logout').addEventListener('click', handleLogout);
            initializeFirebase();
        });
    </script>
</body>
</html>
